---
title: ESP8266çƒ§å½•å›ºä»¶ä¸MCUå¯¹å…¶çš„åˆå§‹åŒ–
date: 2023-12-06
tags:
 - STM32
 - HALåº“
categories:
-  STM32
---

## MCU+ESP8266

æƒ³ä½¿ç”¨ESP8266å»ºç«‹TCPæœåŠ¡å°†MCUä¸²å£æ‰“å°æ•°æ®å‘é€åˆ°ç”µè„‘ä¸Šï¼Œè¿™æ ·æ¥æ”¶æ•°æ®æ—¶ç”µè„‘å¯ä»¥ç¦»è®¾å¤‡è¿œä¸€äº›ã€‚

ä½¿ç”¨æ¨¡å—ä¸ºæœ€æ–°çš„`ESP-12S`

ä»‹ç»å‡ ä¸ªéœ€è¦ç”¨çš„è½¯ä»¶:
1. å»ºç«‹TCPæœåŠ¡çš„ï¼šæˆ‘ç”¨çš„å®‰ä¿¡å¯çš„`TCP&UDPæµ‹è¯•å·¥å…·`ï¼Œå¯é€‰ç½‘ç»œè°ƒè¯•åŠ©æ‰‹ç­‰ã€‚
2. ESP8266è°ƒè¯•å·¥å…·ï¼Œå°†ATæŒ‡ä»¤æŒ‰é”®åŒ–ï¼Œå½“ä¸ç†Ÿæ‚‰ATæŒ‡ä»¤æ—¶ï¼Œå…¥æ‰‹è¿™ä¸ªå¾ˆæ–¹ä¾¿ï¼Œå¯æƒœæ¯æ¬¡é‡æ–°æ‰“å¼€ç¨‹åºä¹‹å‰åšçš„æ›´æ”¹ä¼šè¢«é‡ç½®ï¼Œéœ€è¦é‡å†™WiFiåç§°ã€å¯†ç å’ŒæœåŠ¡IPï¼Œæœ‰ç‚¹éº»çƒ¦ã€‚
3. flash_download_toolï¼Œç»™ESP8266çƒ§å½•å›ºä»¶ã€‚

### çƒ§å½•å›ºä»¶

å‡ºå‚å›ºä»¶ä¸æ”¯æŒæ›´æ”¹ä¸²å£æ³¢ç‰¹ç‡ï¼Œè€Œæˆ‘æƒ³è°ƒé«˜ä¼ æ•°æ®æ›´å¿«ä¸€äº›ï¼Œå°±éœ€è¦å»çƒ§å½•å›ºä»¶ï¼Œæ²¡æƒ³åˆ°ä¸€çƒ§å°±æ˜¯ä¸€ä¸ªä¸‹åˆå•ŠğŸ˜­

æ‰“å¼€çƒ§å½•å·¥å…·é€‰æ‹©`ESP8266`å’Œ`developer`ï¼Œç‚¹ä¸‰ä¸ªç‚¹å¯¼å…¥`factory`ç‰ˆ`bin`æ–‡ä»¶åæŒ‰ç…§å›¾è®¾ä¸”è®¾å¤‡æ­£ç¡®è¿æ¥çƒ§å½•å³å¯ã€‚æ³¢ç‰¹ç‡å¯è°ƒæ•´ä¸º921600é¿å…çƒ§å½•å¤ªæ…¢ã€‚

![20231206072350](https://image.krins.cloud/20231206072350.png)

![20231206071958](https://image.krins.cloud/20231206071958.png)

å½“æˆ‘çƒ§å½•æˆåŠŸåï¼Œé‡è¿ESP8266å‘ç°æ€ä¹ˆå‘é€ATæŒ‡ä»¤éƒ½æ²¡ååº”ï¼Œå½“æˆ‘å°†æ³¢ç‰¹ç‡è°ƒæ•´ä¸º74800ï¼Œè¾“å‡ºä¸å†ä¹±ç è€Œæ˜¯ç±»ä¼¼å¦‚ä¸‹æŠ¥é”™
```shell
ets Jan 8 2013,rst cause:2, boot mode:(3,6)

load 0x40100000, len 6960, room 16
tail 0
chksum 0x4f
load 0x3ffe8008, len 24, room 8
tail 0
chksum 0xc6
load 0x3ffe8020, len 3196, room 8
tail 4
chksum 0x3a
csum 0x3a
```

æˆ‘ä»¥ä¸ºæ˜¯çƒ§å½•å‡ºé”™äº†ï¼Œæ¢äº†è®¸å¤šå›ºä»¶å’ŒSPIçƒ§å½•æ¨¡å¼ï¼Œéƒ½ä¸å¾—ç”¨ã€‚æœ€åå‘ç°åŸæ¥æ˜¯[ä¹é‘«å›ºä»¶](https://docs.espressif.com/projects/esp-at/en/release-v2.2.0.0_esp8266/AT_Binary_Lists/ESP8266_AT_binaries.html)çƒ§å½•åUARTå¼•è„šä¸ºRx:15ï¼ŒTX:13ï¼Œè€Œæˆ‘æ¿è½½è¿çº¿æ˜¯Rx:15ï¼ŒTx:16ï¼Œæ— å¥ˆåªèƒ½æ›´æ¢å…¶ä»–å›ºä»¶ã€‚åœ¨[å®‰ä¿¡å¯ç›¸å…³ç½‘é¡µ](https://docs.ai-thinker.com/esp8266/sdk)æ‰¾åˆ°ä¸€äº›ä¸ä¼šæ”¹å˜å¼•è„šçš„å›ºä»¶ã€‚åšå®‰é€šçš„ATå›ºä»¶ä»ç„¶ä¸èƒ½æ›´æ”¹æ³¢ç‰¹ç‡ï¼Œå°è¯•ç¬¬äº”ä¸ªï¼šå‡ºå‚é»˜è®¤å›ºä»¶ï¼Œç»ˆäºæˆåŠŸæ›´æ”¹æ³¢ç‰¹ç‡è€Œä¸æ˜¯è¿”å›ERRORäº†ã€‚

æ³¨æ„æ›´æ”¹æ³¢ç‰¹ç‡ä¹‹å‰è¦ç”¨å›ºä»¶é»˜è®¤çš„115200é€Ÿç‡è¿æ¥é€šä¿¡ï¼Œç„¶åä½¿ç”¨`AT+CIOBAUD=921600`è®¾ç½®æ–°çš„æ³¢ç‰¹ç‡ä¸º921600ï¼Œè¿™ä¸ªè®¾ç½®æ‰ç”µèƒ½ä¼šä¿å­˜ä¸ç”¨é‡æ–°è®¾ç½®ã€‚ç„¶åæ–­å¼€ä¸²å£ï¼Œç”¨921600é€Ÿç‡é‡è¿ä¸²å£å°±èƒ½å’Œè®¾å¤‡æ­£å¸¸é€šä¿¡è€Œä¸ä¼šä¹±ç äº†ã€‚

[ä¹é‘«ATæŒ‡ä»¤é›†](https://docs.espressif.com/projects/esp-at/zh_CN/latest/esp32/AT_Command_Set/Basic_AT_Commands.html#)ï¼Œä¸ä¿è¯å›ºä»¶å®Œå…¨æ”¯æŒã€‚

### ä½¿ç”¨MCUåˆå§‹åŒ–ESP8266å»ºç«‹ç½‘ç»œæœåŠ¡

é¦–å…ˆç¡®ä¿ä¸¤ä¸ªè®¾å¤‡çš„ä¸²å£æ­£ç¡®è¿æ¥ã€‚

```c
extern UART_HandleTypeDef huart2;

char *SSID = "LAPTOP-LI4396";
char *PASSWORD = "-Y24j533";
char *serverIP = "192.168.137.1";
char *serverPort = "800";

void ESP8266_Init()
{
    // AT commands for ESP8266
    printf("+++");
    HAL_Delay(1500);
    ESP8266_Test();                              // test AT startup
    while (!WaitingForResponse("OK"));
    ESP8266_Reset();                             // soft reset
    while (!WaitingForResponse("OK"));
    ESP8266_SetMode(1);                          // set mode to station
    while (!WaitingForResponse("OK"));
    ESP8266_ConnectWifi(SSID, PASSWORD);         // connect to AP
    while (!WaitingForResponse("IP"));
    ESP8266_CIPSTATUS();                         // check connection status
    while (!WaitingForResponse("OK"));
    ESP8266_SetMultipleConnections(0);           // set single connection mode
    while (!WaitingForResponse("OK"));
    ESP8266_ConnectServer(serverIP, serverPort); // connect to server
    while (!WaitingForResponse("OK"));
    ESP8266_TransTxEnable(1);                    // enable transparent transmission
    while (!WaitingForResponse("OK"));
    ESP8266_TransTxStart();                      // start transparent transmission
    while (!WaitingForResponse("OK"));
    printf("Hello World\r\n");          // send data
}
```
```c
void ESP8266_Test()
{
    printf("AT\r\n");
} // should return OK

// soft reset
void ESP8266_Reset()
{
    printf("AT+RST\r\n");
} // should return OK

// *view class
/*
AT+CMD? check current value
AT+CMD=? check command setting range
AT+CMD execute command
*/

// check mode
void ESP8266_CheckMode()
{
    printf("AT+CWMODE?\r\n");
} // should return mode

// 1 is station, 2 is AP, 3 is both
void ESP8266_SetMode(int mode)
{
    printf("AT+CWMODE=%d\r\n", mode);
}

void ESP8266_ConnectWifi(char *ssid, char *password)
{
    printf("AT+CWJAP=\"%s\",\"%s\"\r\n", ssid, password);
}


// check connection status
void ESP8266_CIPSTATUS()
{
    printf("AT+CIPSTATUS\r\n");
}

// 0 is single, 1 is multiple
void ESP8266_SetMultipleConnections(int enable)
{
    printf("AT+CIPMUX=%d\r\n", enable ? 1 : 0);
}

// conncet to server using TCP
void ESP8266_ConnectServer(char *ip, char *port)
{
    printf("AT+CIPSTART=\"TCP\",\"%s\",%s\r\n", ip, port);
}

// 0 is non-transparent, 1 is transparent
void ESP8266_TransTxEnable(int enable)
{
    printf("AT+CIPMODE=%d\r\n", enable ? 1 : 0);
}
void ESP8266_TransTxStart()
{
    printf("AT+CIPSEND\r\n");
}

// close Transparent Transmission
void ESP8266_TransTxCancle()
{
    printf("+++");
}

// auto connect to server and enable transparent transmission
void ESP8266_AutoConnect()
{
    printf("AT+SAVETRANSLINK=1,\"%s\",%d,\"TCP\"\r\n", serverIP, serverPort);
}

```

```c
int WaitingForResponse(char *response)
{
int i = 0, j = 0;
    char c;
    char buffer[100];
    int response_length = strlen(response);
    while (1)
    {
        if (HAL_UART_Receive(&huart2, (uint8_t *)&c, 1, 1000) == HAL_OK)
        {
            if (c == response[i])
            {
                buffer[j++] = c;
                i++;
                if (i == response_length)
                {
                    buffer[j] = '\0';
                    return 1;
                }
            }
            else
            {
                i = 0;
                j = 0;
            }
        }
        else
        {
            return 0;
        }
    }
}
```
