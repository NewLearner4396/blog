<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.19">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <style>
      .features__container .magic-card.features__item{
        text-align: center;
        > h4 { font-size: 24px; }
        > p { font-size: 30px; }
      } 
    </style><style>
      .math-block {
        overflow-x: auto; /* 对于长公式，允许水平滚动 */
        margin: 1em 0;
      }
    </style><meta name="referrer" content="no-referrer"><title>openCV库的学习笔记 | Land of Fragment</title><meta name="description" content="My Knowledge Fragments">
    <link rel="preload" href="/assets/style-6pge_xnY.css" as="style"><link rel="stylesheet" href="/assets/style-6pge_xnY.css">
    <link rel="modulepreload" href="/assets/app-BSRiWrsC.js"><link rel="modulepreload" href="/assets/opencv-python.html-DF92fizP.js">
    <link rel="prefetch" href="/assets/timeline.html-DfeHn2Tg.js" as="script"><link rel="prefetch" href="/assets/posts.html-BfZDQn9T.js" as="script"><link rel="prefetch" href="/assets/friendship-link.html-CUdkYGNJ.js" as="script"><link rel="prefetch" href="/assets/1.html-XvgtUsnW.js" as="script"><link rel="prefetch" href="/assets/1.html-avnTqInM.js" as="script"><link rel="prefetch" href="/assets/1.html-NgcU7KSV.js" as="script"><link rel="prefetch" href="/assets/1.html-CXE0zHtL.js" as="script"><link rel="prefetch" href="/assets/1.html-Cog-kVKi.js" as="script"><link rel="prefetch" href="/assets/1.html-_zvhubRJ.js" as="script"><link rel="prefetch" href="/assets/1.html-ClCg7FGd.js" as="script"><link rel="prefetch" href="/assets/1.html-yt_aD5jy.js" as="script"><link rel="prefetch" href="/assets/1.html-CB0KW2iW.js" as="script"><link rel="prefetch" href="/assets/1.html-BowE8ARr.js" as="script"><link rel="prefetch" href="/assets/1.html-eqCr6DX7.js" as="script"><link rel="prefetch" href="/assets/1.html-BzUo2DSG.js" as="script"><link rel="prefetch" href="/assets/1.html-Bbsmxffu.js" as="script"><link rel="prefetch" href="/assets/1.html-D1KaZrYC.js" as="script"><link rel="prefetch" href="/assets/1.html-BsZV3kvN.js" as="script"><link rel="prefetch" href="/assets/1.html-BGm0_Wx5.js" as="script"><link rel="prefetch" href="/assets/1.html-B1kFZ9mE.js" as="script"><link rel="prefetch" href="/assets/1.html-DGrhAkLt.js" as="script"><link rel="prefetch" href="/assets/1.html-DZ1nTxId.js" as="script"><link rel="prefetch" href="/assets/1.html-CMIkUwD8.js" as="script"><link rel="prefetch" href="/assets/1.html-BNjog0ni.js" as="script"><link rel="prefetch" href="/assets/1.html-Cc40ApdK.js" as="script"><link rel="prefetch" href="/assets/1.html-Bj7-p0It.js" as="script"><link rel="prefetch" href="/assets/1.html-BLQwyT21.js" as="script"><link rel="prefetch" href="/assets/1.html-BOd0TIhR.js" as="script"><link rel="prefetch" href="/assets/1.html-UOioTLnQ.js" as="script"><link rel="prefetch" href="/assets/1.html-DCqxRPiQ.js" as="script"><link rel="prefetch" href="/assets/1.html-Cf7jkBFG.js" as="script"><link rel="prefetch" href="/assets/1.html-Bffo7Z9I.js" as="script"><link rel="prefetch" href="/assets/1.html-DGQzGuaA.js" as="script"><link rel="prefetch" href="/assets/1.html-1aLZjQaN.js" as="script"><link rel="prefetch" href="/assets/1.html-B98SEDc9.js" as="script"><link rel="prefetch" href="/assets/1.html-hj_htl7b.js" as="script"><link rel="prefetch" href="/assets/1.html-C7vICF5f.js" as="script"><link rel="prefetch" href="/assets/1.html-CUjZWUGs.js" as="script"><link rel="prefetch" href="/assets/1.html-CVU23UYr.js" as="script"><link rel="prefetch" href="/assets/1.html-Dn3fPxPr.js" as="script"><link rel="prefetch" href="/assets/1.html-CFEAodqK.js" as="script"><link rel="prefetch" href="/assets/1.html-C4TaKn5K.js" as="script"><link rel="prefetch" href="/assets/1.html-Dw9Zp6ML.js" as="script"><link rel="prefetch" href="/assets/1.html-BBvl4a-w.js" as="script"><link rel="prefetch" href="/assets/1.html-Coi_xg1g.js" as="script"><link rel="prefetch" href="/assets/1.html-CBBFrxJ9.js" as="script"><link rel="prefetch" href="/assets/1.html-BJ0IZfEG.js" as="script"><link rel="prefetch" href="/assets/1.html-TVL-fUtr.js" as="script"><link rel="prefetch" href="/assets/1.html-Disg0Tqq.js" as="script"><link rel="prefetch" href="/assets/2.html-Dgu2oU6o.js" as="script"><link rel="prefetch" href="/assets/3.html-BjFB_Ca1.js" as="script"><link rel="prefetch" href="/assets/4.html-CouYwquB.js" as="script"><link rel="prefetch" href="/assets/5.html-4huYDZh2.js" as="script"><link rel="prefetch" href="/assets/index.html-BaBP6NH6.js" as="script"><link rel="prefetch" href="/assets/Ubuntu.html-CUyx21fh.js" as="script"><link rel="prefetch" href="/assets/VSCode_Jupyter.html-BrhSNgRK.js" as="script"><link rel="prefetch" href="/assets/VSCode_LaTex.html-CTTLq7av.js" as="script"><link rel="prefetch" href="/assets/VSCode_Markdown.html-BfVUtb9r.js" as="script"><link rel="prefetch" href="/assets/VSCode_Matlab.html-wpgIPqA2.js" as="script"><link rel="prefetch" href="/assets/VSCode_Plugins.html-CdFuU2Uj.js" as="script"><link rel="prefetch" href="/assets/VSCode_Verilog.html-C7TEj0F3.js" as="script"><link rel="prefetch" href="/assets/WSL.html-CkqDkr5C.js" as="script"><link rel="prefetch" href="/assets/ssh.html-CdxNmekp.js" as="script"><link rel="prefetch" href="/assets/FFT.html-Cyt0G-8Y.js" as="script"><link rel="prefetch" href="/assets/LinearAlgebra.html-CUYJNMjB.js" as="script"><link rel="prefetch" href="/assets/motorControl.html-rOORs7Mj.js" as="script"><link rel="prefetch" href="/assets/regression.html-DzFtGkXK.js" as="script"><link rel="prefetch" href="/assets/AI_Preliminary.html-DhcBMHnG.js" as="script"><link rel="prefetch" href="/assets/CNN.html-NVeUXorf.js" as="script"><link rel="prefetch" href="/assets/HandWritingRecognize_CNN.html-BIUQzCZf.js" as="script"><link rel="prefetch" href="/assets/MOS.html-CEkMf0Uk.js" as="script"><link rel="prefetch" href="/assets/Tips.html-DlmxC6lL.js" as="script"><link rel="prefetch" href="/assets/ecofinance.html-jWWDV__x.js" as="script"><link rel="prefetch" href="/assets/git.html-jo8r2u5q.js" as="script"><link rel="prefetch" href="/assets/image.html-Bq075vBZ.js" as="script"><link rel="prefetch" href="/assets/matlab.html-CO3aL8yS.js" as="script"><link rel="prefetch" href="/assets/Domain.html-BO42RH5D.js" as="script"><link rel="prefetch" href="/assets/script_UWB.html-nOBmZfSl.js" as="script"><link rel="prefetch" href="/assets/ChristmasTree.html-C7Yz5WQx.js" as="script"><link rel="prefetch" href="/assets/Comment_on_teaching_Script.html-M0-_XaU6.js" as="script"><link rel="prefetch" href="/assets/OriginGuide.html-DU-IiK_m.js" as="script"><link rel="prefetch" href="/assets/ReWIPI_NRAM.html-EkJFemCP.js" as="script"><link rel="prefetch" href="/assets/datetime.html-Dgd43jgJ.js" as="script"><link rel="prefetch" href="/assets/keyword.html-CsusZbU4.js" as="script"><link rel="prefetch" href="/assets/matplotlib.html-rFtu0-2W.js" as="script"><link rel="prefetch" href="/assets/numpy.html-BXRLo128.js" as="script"><link rel="prefetch" href="/assets/openpyxl.html-DdbQgKef.js" as="script"><link rel="prefetch" href="/assets/pandas.html-BJRB917g.js" as="script"><link rel="prefetch" href="/assets/statsmodels.html-CO0vW7nK.js" as="script"><link rel="prefetch" href="/assets/time.html-xHI8FETd.js" as="script"><link rel="prefetch" href="/assets/wordcloud.html-BAcUpAHT.js" as="script"><link rel="prefetch" href="/assets/ESP8266.html-qWvnuWBu.js" as="script"><link rel="prefetch" href="/assets/MacroTips_C.html-DsrGeKeX.js" as="script"><link rel="prefetch" href="/assets/Start.html-DpAVNQfM.js" as="script"><link rel="prefetch" href="/assets/usart.html-DGDMRk2c.js" as="script"><link rel="prefetch" href="/assets/Communication_principle.html-NMtyjosA.js" as="script"><link rel="prefetch" href="/assets/Digitial_Signal_Processing.html-CuapP71y.js" as="script"><link rel="prefetch" href="/assets/Random_Signal_Analysis.html-CzWnqTqP.js" as="script"><link rel="prefetch" href="/assets/Signal_and_System.html-NlRnhwLG.js" as="script"><link rel="prefetch" href="/assets/api.html-BV-KS8aa.js" as="script"><link rel="prefetch" href="/assets/home.html-DmI8oyYt.js" as="script"><link rel="prefetch" href="/assets/plugin.html-BZGUY2mm.js" as="script"><link rel="prefetch" href="/assets/theme.html-B7OyyY3g.js" as="script"><link rel="prefetch" href="/assets/404.html-D8Kgek98.js" as="script"><link rel="prefetch" href="/assets/Valine.min-_LyT3bfY.js" as="script"><link rel="prefetch" href="/assets/giscus-aTimukGI-DWEKOTfS.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container series--no show-catalog"><header class="navbar-container not-open"><div class="navbar-inner"><div class="site-brand nav-item"><img class="logo" src="/logo.png" alt="Land of Fragment"><a href="/" class="site-name can-hide">Land of Fragment</a></div><div class="nav-item navbar-links-wrapper" style=""><div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/" class="link" aria-label="Home"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Home<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/timeline.html" class="link" aria-label="TimeLine"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->TimeLine<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/categories/Others/1.html" class="link" aria-label="Categories"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Categories<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/tags/Tips/1.html" class="link" aria-label="Tags"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Tags<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><div class="dropdown-link"><button class="dropdown-link__title" type="button" aria-label="Docs"><span class="xicon-container left title"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Docs<!--]--></span></span><span class="arrow down"></span></button><button class="dropdown-link--mobile__title" type="button" aria-label="Docs"><span class="title"><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Docs<!--]--></span></span></span><span class="right arrow"></span></button><ul style="display:none;" class="dropdown-link__container"><!--[--><li class="dropdown-link__item"><a href="/docs/theme-reco/theme" class="link" aria-label="vuepress-reco"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->vuepress-reco<!--]--></span></span><!--[--><!--]--></a></li><li class="dropdown-link__item"><a href="/blogs/Others/OriginGuide" class="link" aria-label="vuepress-theme-reco"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->vuepress-theme-reco<!--]--></span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links__item"><a href="/friendship-link.html" class="link" aria-label="Link"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Link<!--]--></span></span><!--[--><!--]--></a></div><!--]--><!----><span class="xicon-container btn-toggle-dark-mode btn--dark-mode navbar-links__item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></span><ul class="social-links navbar-links__item"><!--[--><!--]--></ul></nav><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div></div></header><!----><!----><!----><div class="theme-main" style=""><!----><!--[--><main class="page-container"><div class="page-content"><h1 class="page-title">openCV库的学习笔记</h1><div class="page-info"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->NewLearner4396<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2022-09-03<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/categories/Lang/1.html" class="">Lang</a><!--]--><!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M10 14a4 4 0 1 1 4-4a4.005 4.005 0 0 1-4 4zm0-6a2 2 0 1 0 1.998 2.004A2.002 2.002 0 0 0 10 8z" fill="currentColor"></path><path d="M16.644 29.415L2.586 15.354A2 2 0 0 1 2 13.941V4a2 2 0 0 1 2-2h9.941a2 2 0 0 1 1.414.586l14.06 14.058a2 2 0 0 1 0 2.828l-9.943 9.943a2 2 0 0 1-2.829 0zM4 4v9.942L18.058 28L28 18.058L13.942 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/tags/Python/1.html" class="">Python</a><!--]--><!--]--></span></span><!----></div><div class="theme-reco-md-content"><div><h2 id="opencv-python库的使用" tabindex="-1"><a class="header-anchor" href="#opencv-python库的使用"><span>openCV-python库的使用</span></a></h2><h4 id="库的导入" tabindex="-1"><a class="header-anchor" href="#库的导入"><span>库的导入</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 库的导入</span></span>
<span class="line"><span class="token keyword">import</span> cv2 <span class="token keyword">as</span> cv</span>
<span class="line"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np</span>
<span class="line"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="数据类型宏定义" tabindex="-1"><a class="header-anchor" href="#数据类型宏定义"><span>数据类型宏定义</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 数据类型宏定义</span></span>
<span class="line">S <span class="token operator">=</span> 有符号整型 U <span class="token operator">=</span> 无符号整型 F <span class="token operator">=</span> 浮点型</span>
<span class="line"></span>
<span class="line">CV_8U <span class="token operator">-</span> <span class="token number">8</span>位无符号整数（<span class="token number">0</span>…<span class="token number">255</span>）</span>
<span class="line">CV_8S <span class="token operator">-</span> <span class="token number">8</span>位有符号整数（<span class="token operator">-</span><span class="token number">128</span>…<span class="token number">127</span>）</span>
<span class="line">CV_16U <span class="token operator">-</span> <span class="token number">16</span>位无符号整数（<span class="token number">0</span>…<span class="token number">65535</span>）</span>
<span class="line">CV_16S <span class="token operator">-</span> <span class="token number">16</span>位有符号整数（<span class="token operator">-</span><span class="token number">32768</span>…<span class="token number">32767</span>）</span>
<span class="line">CV_32S <span class="token operator">-</span> <span class="token number">32</span>位有符号整数（<span class="token operator">-</span><span class="token number">2147483648</span>…<span class="token number">2147483647</span>）</span>
<span class="line">CV_32F <span class="token operator">-</span> <span class="token number">32</span>位浮点数（<span class="token operator">-</span>FLT_MAX…FLT_MAX，INF，NAN）</span>
<span class="line">CV_64F <span class="token operator">-</span> <span class="token number">64</span>位浮点数（<span class="token operator">-</span>DBL_MAX…DBL_MAX，INF，NAN）</span>
<span class="line"></span>
<span class="line">而C1、C2、C3是什么意思呢？</span>
<span class="line">这里的<span class="token number">1</span>、<span class="token number">2</span>、<span class="token number">3</span>代表的是通道数，比如RGB就是<span class="token number">3</span>通道，颜色表示最大为<span class="token number">255</span><span class="token punctuation">,</span>所以可以用CV_8UC3这个数据类型来表示<span class="token punctuation">;</span>灰度图就是C1，只有一个通道；而带alpha通道的PNG图像就是C4，是<span class="token number">4</span>通道图片。</span>
<span class="line">参考：<span class="token operator">&lt;</span>https<span class="token punctuation">:</span><span class="token operator">//</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>ai_faker<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">118183702</span><span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="图片读取" tabindex="-1"><a class="header-anchor" href="#图片读取"><span>图片读取</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 读取图片，以BGR格式存储</span></span>
<span class="line">cv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>path，<span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">/</span>cv<span class="token punctuation">.</span>IMREAD_GRAYSCALE<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 为0则读取为灰度图</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="图片保存" tabindex="-1"><a class="header-anchor" href="#图片保存"><span>图片保存</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 写入图片</span></span>
<span class="line">cv<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>path<span class="token punctuation">,</span>obj<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="图片显示" tabindex="-1"><a class="header-anchor" href="#图片显示"><span>图片显示</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 显示图片</span></span>
<span class="line">cv<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">&#39;windowsname&#39;</span><span class="token punctuation">,</span>obj<span class="token punctuation">)</span></span>
<span class="line">cv<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">#等待按键响应，为0则一直等待,否则该窗口会很快关掉</span></span>
<span class="line">cv<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span>cv<span class="token punctuation">.</span>destroyWindow<span class="token punctuation">(</span><span class="token string">&#39;windowsname&#39;</span><span class="token punctuation">)</span> <span class="token comment"># 关闭图像窗口</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="视频读取" tabindex="-1"><a class="header-anchor" href="#视频读取"><span>视频读取</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 读取视频</span></span>
<span class="line">vedio <span class="token operator">=</span> cv<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>‘path’<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#检查是否打开正确</span></span>
<span class="line"><span class="token keyword">if</span> vedio<span class="token punctuation">.</span>isOpened<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token builtin">open</span><span class="token punctuation">,</span>frame <span class="token operator">=</span> vedio<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span> </span>
<span class="line">    <span class="token comment">#vedio.read()返回是否正常打开以及当前帧，循环执行可一直读取后面的帧 </span></span>
<span class="line"><span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token builtin">open</span> <span class="token operator">=</span> <span class="token boolean">False</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">while</span> <span class="token builtin">open</span><span class="token punctuation">:</span></span>
<span class="line">    ret<span class="token punctuation">,</span>frame <span class="token operator">=</span> vedio<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> frame <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">if</span> ret <span class="token operator">==</span> <span class="token boolean">True</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 以灰度图显示</span></span>
<span class="line">        video_gray <span class="token operator">=</span> cv<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>frame<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span></span>
<span class="line">        cv<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">&#39;img_gray&#39;</span><span class="token punctuation">,</span>video_gray<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment"># 设置1s播放25帧</span></span>
<span class="line">        cv<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token number">0xFF</span> <span class="token operator">==</span> <span class="token number">27</span><span class="token punctuation">:</span><span class="token comment"># 按下Esc键则退出</span></span>
<span class="line">            <span class="token keyword">break</span></span>
<span class="line">vedio<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 释放vedio的内存</span></span>
<span class="line">cv<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># 关闭所有窗口</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="图片边界填充" tabindex="-1"><a class="header-anchor" href="#图片边界填充"><span>图片边界填充</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment">#边界填充</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 填充多少区域</span></span>
<span class="line">top_size<span class="token punctuation">,</span>bottom_size<span class="token punctuation">,</span>left_size<span class="token punctuation">,</span>right_size <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span>  </span>
<span class="line"></span>
<span class="line"><span class="token comment"># 最后一个入口参数为填充方式</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 方式一：复制法，复制最边缘像素</span></span>
<span class="line">replicate <span class="token operator">=</span> cv<span class="token punctuation">.</span>copyMakeBorder<span class="token punctuation">(</span>img<span class="token punctuation">,</span>top_size<span class="token punctuation">,</span>bottom_size<span class="token punctuation">,</span>left_size<span class="token punctuation">,</span>right_size<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>BORDER_REPLICATE<span class="token punctuation">)</span> </span>
<span class="line"><span class="token comment"># 方式二：反射法，对感兴趣的图像中的像素在两边进行复制例如：fedcba|abcdefgh|hgfedcb</span></span>
<span class="line">reflect <span class="token operator">=</span> cv<span class="token punctuation">.</span>copyMakeBorder<span class="token punctuation">(</span>img<span class="token punctuation">,</span>top_size<span class="token punctuation">,</span>bottom_size<span class="token punctuation">,</span>left_size<span class="token punctuation">,</span>right_size<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>BORDER_REFLECT<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 方式三：反射法，也就是以最边缘像素为轴，对称，gfedcb|abcdefgh|gfedcba</span></span>
<span class="line">reflect101 <span class="token operator">=</span> cv<span class="token punctuation">.</span>copyMakeBorder<span class="token punctuation">(</span>img<span class="token punctuation">,</span>top_size<span class="token punctuation">,</span>bottom_size<span class="token punctuation">,</span>left_size<span class="token punctuation">,</span>right_size<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>BORDER_REFLECT_101<span class="token punctuation">)</span>      </span>
<span class="line"><span class="token comment"># 方式四：外包装法cdefgh|abcdefgh|abcdefg</span></span>
<span class="line">wrap <span class="token operator">=</span> cv<span class="token punctuation">.</span>copyMakeBorder<span class="token punctuation">(</span>img<span class="token punctuation">,</span>top_size<span class="token punctuation">,</span>bottom_size<span class="token punctuation">,</span>left_size<span class="token punctuation">,</span>right_size<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>BORDER_WRAP<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 方式五：常量法，常数值填充</span></span>
<span class="line">constant <span class="token operator">=</span> cv<span class="token punctuation">.</span>copyMakeBorder<span class="token punctuation">(</span>img<span class="token punctuation">,</span>top_size<span class="token punctuation">,</span>bottom_size<span class="token punctuation">,</span>left_size<span class="token punctuation">,</span>right_size<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>BORDER_CONSTANT<span class="token punctuation">,</span>value<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://imagebed.krins.cloud/api/image/D0T2B28R.png#pic_center" alt="各填充法对比"></p><h4 id="修改图片大小" tabindex="-1"><a class="header-anchor" href="#修改图片大小"><span>修改图片大小</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 修改图片大小</span></span>
<span class="line">cv<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>fx<span class="token punctuation">,</span>fy<span class="token punctuation">,</span>interpolation<span class="token punctuation">)</span> <span class="token comment"># 注意先输入列数再输入行数</span></span>
<span class="line">cv<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>fx<span class="token operator">=</span>alpha<span class="token punctuation">,</span>fy<span class="token operator">=</span>beta<span class="token punctuation">)</span> <span class="token comment"># 横向拉伸alpha倍，纵向拉伸beta倍</span></span>
<span class="line"><span class="token string">&quot;interpolation&quot;</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token string">&quot;INTER_NEAREST&quot;</span><span class="token punctuation">:</span>最近邻插值</span>
<span class="line">    <span class="token string">&quot;INTER_LINEAR&quot;</span><span class="token punctuation">:</span>双线性插值（默认）</span>
<span class="line">    <span class="token string">&quot;INTER_AREA&quot;</span><span class="token punctuation">:</span>使用像素区域关系重采样</span>
<span class="line">    <span class="token string">&quot;INTER_CUBIC&quot;</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">4</span>邻域的双三次插值</span>
<span class="line">    <span class="token string">&quot;INTER_LANCZOS4&quot;</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token operator">*</span><span class="token number">8</span>邻域的Lanczos插值</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="图像二值化" tabindex="-1"><a class="header-anchor" href="#图像二值化"><span>图像二值化</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 设置图像阈值</span></span>
<span class="line"><span class="token comment"># ret, dst = cv.threshold(src, thresh, maxval, type)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># src： 输入图，只能输入单通道图像，通常来说为灰度图</span></span>
<span class="line"><span class="token comment"># thresh： 阈值</span></span>
<span class="line"><span class="token comment"># dst： 输出图</span></span>
<span class="line"><span class="token comment"># ret： 设置阈值</span></span>
<span class="line"><span class="token comment"># maxval： 当像素值超过了阈值 ( 或者小于阈值，根据 type 来决定 )，所赋予的值</span></span>
<span class="line"><span class="token comment"># type：二值化操作的类型，包含以下5种类型：</span></span>
<span class="line"><span class="token comment"># cv2.THRESH_BINARY          超过阈值部分取maxval ( 最大值 )，否则取0</span></span>
<span class="line"><span class="token comment"># cv2.THRESH_BINARY_INV      THRESH_BINARY的反转</span></span>
<span class="line"><span class="token comment"># cv2.THRESH_TRUNC           大于阈值部分设为阈值，否则不变</span></span>
<span class="line"><span class="token comment"># cv2.THRESH_TOZERO          大于阈值部分不改变，否则设为0</span></span>
<span class="line"><span class="token comment"># cv2.THRESH_TOZERO_INV      THRESH_TOZERO的反转</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://imagebed.krins.cloud/api/image/8HNP8ND8.png#pic_center" alt="image-20220904095126260"></p><h4 id="图像归一化" tabindex="-1"><a class="header-anchor" href="#图像归一化"><span>图像归一化</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 将tarImg放缩到0~1后提亮到原最大亮度</span></span>
<span class="line">maxV <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>tarImg<span class="token punctuation">)</span></span>
<span class="line">res <span class="token operator">=</span> cv2<span class="token punctuation">.</span>normalize<span class="token punctuation">(</span>tarImg<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>NORM_MINMAX<span class="token punctuation">,</span> dtype<span class="token operator">=</span>cv2<span class="token punctuation">.</span>CV_64F<span class="token punctuation">)</span><span class="token operator">*</span>maxV</span>
<span class="line">res <span class="token operator">=</span> res<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="图像滤波" tabindex="-1"><a class="header-anchor" href="#图像滤波"><span>图像滤波</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 图像滤波</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 均值滤波</span></span>
<span class="line"><span class="token comment"># 简单的平均卷积操作，方框中的值相加，取平均</span></span>
<span class="line">blur <span class="token operator">=</span> cv2<span class="token punctuation">.</span>blur<span class="token punctuation">(</span>img<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># (3,3) 为核的大小，通常情况核都是奇数 3、5、7</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 方框滤波</span></span>
<span class="line"><span class="token comment"># 选择归一化后基本和均值滤波一样。不归一化则卷积完不做平均，越界则强设为255，容易过曝</span></span>
<span class="line"><span class="token comment"># 在 Python 中 -1 表示自适应填充对应的值，这里的 -1 表示与颜色通道数自适应一样</span></span>
<span class="line">box <span class="token operator">=</span> cv2<span class="token punctuation">.</span>boxFilter<span class="token punctuation">(</span>img<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>normalize<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> </span>
<span class="line"><span class="token comment"># 方框滤波如果做归一化，得到的结果和均值滤波一模一样</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 高斯滤波</span></span>
<span class="line"><span class="token comment"># 用满足高斯分布的值作为卷积核的数</span></span>
<span class="line"><span class="token comment"># 离中心值越近的，它的权重越大，离中心值越远的，它的权重越小。</span></span>
<span class="line"><span class="token comment"># 1指卷积核数值高斯分布的标准差取1</span></span>
<span class="line">aussian <span class="token operator">=</span> cv2<span class="token punctuation">.</span>GaussianBlur<span class="token punctuation">(</span>img<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 中值滤波</span></span>
<span class="line"><span class="token comment"># 取当前像素点机周围像素点排序后拿中值替代中间元素值的大小</span></span>
<span class="line">median <span class="token operator">=</span> cv2<span class="token punctuation">.</span>medianBlur<span class="token punctuation">(</span>img<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment"># ksize为卷积核大小，必须为比1大的奇数</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="形态学处理" tabindex="-1"><a class="header-anchor" href="#形态学处理"><span>形态学处理</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 形态学处理</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 图像腐蚀</span></span>
<span class="line"><span class="token comment"># 通常是拿二值图像做腐蚀操作，去掉一些小毛刺</span></span>
<span class="line"><span class="token comment"># 只要框里有黑色，中心点的值就变为黑色，即原来的白色被黑色腐蚀掉</span></span>
<span class="line"><span class="token comment"># kernel是卷积核，iteration是迭代次数</span></span>
<span class="line">kernel <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span></span>
<span class="line">erosion <span class="token operator">=</span> cv<span class="token punctuation">.</span>erode<span class="token punctuation">(</span>img<span class="token punctuation">,</span>kernel<span class="token punctuation">,</span>iterations<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 图像膨胀</span></span>
<span class="line"><span class="token comment"># 图像腐蚀的逆操作</span></span>
<span class="line"><span class="token comment"># 先腐蚀 后膨胀，简单修复腐蚀造成的损害</span></span>
<span class="line">kernel <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span></span>
<span class="line">erosion <span class="token operator">=</span> cv<span class="token punctuation">.</span>dilate<span class="token punctuation">(</span>img<span class="token punctuation">,</span>kernel<span class="token punctuation">,</span>iterations<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 开运算：先腐蚀再膨胀</span></span>
<span class="line">kernel <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span></span>
<span class="line">opening <span class="token operator">=</span> cv<span class="token punctuation">.</span>morphologyEx<span class="token punctuation">(</span>img<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>MORPH_OPEN<span class="token punctuation">,</span>kernel<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 闭运算：先膨胀后腐蚀</span></span>
<span class="line">kernel <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>unit8<span class="token punctuation">)</span></span>
<span class="line">closing <span class="token operator">=</span> cv<span class="token punctuation">.</span>morphologyEx<span class="token punctuation">(</span>img<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>MORPH_CLOSE<span class="token punctuation">,</span>kernel<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 梯度运算：膨胀-腐蚀</span></span>
<span class="line"><span class="token comment"># 获取图像的边界信息</span></span>
<span class="line">kernel <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>unit8<span class="token punctuation">)</span></span>
<span class="line">gradient <span class="token operator">=</span> cv<span class="token punctuation">.</span>morphologyEx<span class="token punctuation">(</span>img<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>MORPH_GRADIENT<span class="token punctuation">,</span>kernel<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 礼帽：原始输入-开运算结果</span></span>
<span class="line"><span class="token comment"># 获取毛刺部分</span></span>
<span class="line">kernel <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>unit8<span class="token punctuation">)</span></span>
<span class="line">tophat <span class="token operator">=</span> cv<span class="token punctuation">.</span>morphologyEx<span class="token punctuation">(</span>img<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>MORPH_TOPHAT<span class="token punctuation">,</span>kernel<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 黑帽：闭运算-原始输入</span></span>
<span class="line"><span class="token comment"># 获取图像轮廓</span></span>
<span class="line">kernel <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>unit8<span class="token punctuation">)</span></span>
<span class="line">blackhat <span class="token operator">=</span> cv<span class="token punctuation">.</span>morphologyEx<span class="token punctuation">(</span>img<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>MORPH_BLACKHAT<span class="token punctuation">,</span>kernel<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="图像梯度" tabindex="-1"><a class="header-anchor" href="#图像梯度"><span>图像梯度</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># Sobel算子</span></span>
<span class="line">cv2<span class="token punctuation">.</span>Sobel<span class="token punctuation">(</span>src<span class="token punctuation">,</span> ddepth<span class="token punctuation">,</span> dx<span class="token punctuation">,</span> dy<span class="token punctuation">,</span> ksize<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 返回Sobel算子处理后的图像</span></span>
<span class="line"><span class="token comment"># ddepth：图像的深度</span></span>
<span class="line"><span class="token comment"># dx 和 dy 分别表示水平和竖直方向</span></span>
<span class="line"><span class="token comment"># ksize 是 Sobel 算子的大小</span></span>
<span class="line"></span>
<span class="line">sobelx <span class="token operator">=</span> cv<span class="token punctuation">.</span>Sobel<span class="token punctuation">(</span>img<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>CV_64F<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>ksize<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span> </span>
<span class="line"><span class="token comment"># 1,0 表示只算水平方向梯度</span></span>
<span class="line"><span class="token comment"># 用cv.CV_64F表示图像深度为1的同时，将图像转为浮点数，避免返回值将负数截断为0</span></span>
<span class="line"><span class="token comment"># 白到黑是正数，黑到白是负数了，所有的负数不作处理会被截断成 0，所以要取绝对值</span></span>
<span class="line">sobelx <span class="token operator">=</span> cv<span class="token punctuation">.</span>convertScaleAbs<span class="token punctuation">(</span>sobelx<span class="token punctuation">)</span> </span>
<span class="line"></span>
<span class="line"><span class="token comment"># 不建议一起计算dx、dy,容易出现重影</span></span>
<span class="line">sobelxy <span class="token operator">=</span> cv2<span class="token punctuation">.</span>Sobel<span class="token punctuation">(</span>img<span class="token punctuation">,</span>cv2<span class="token punctuation">.</span>CV_64F<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>ksize<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span></span>
<span class="line">sobelxy <span class="token operator">=</span> cv2<span class="token punctuation">.</span>convertScaleAbs<span class="token punctuation">(</span>sobelxy<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 可以分别计算dx和dy后，再求和</span></span>
<span class="line">sobelxy <span class="token operator">=</span> cv2<span class="token punctuation">.</span>addWeighted<span class="token punctuation">(</span>sobelx<span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span>sobely<span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Scharr算子</span></span>
<span class="line">cv<span class="token punctuation">.</span>Scharr<span class="token punctuation">(</span>src<span class="token punctuation">,</span> ddepth<span class="token punctuation">,</span> dx<span class="token punctuation">,</span> dy<span class="token punctuation">,</span> ksize<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 加大了边缘的权重，对纹理的识别更敏感一些</span></span>
<span class="line"><span class="token comment"># 整体使用和Sobel算子差不多，没有ksize这个参数</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Laplacian算子</span></span>
<span class="line">cv<span class="token punctuation">.</span>Laplacian<span class="token punctuation">(</span>img<span class="token punctuation">,</span>ddepth<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 直接与邻近值比较，没有dx，dy的选项</span></span>
<span class="line"><span class="token comment"># 对噪音点更敏感，与其他方法配合使用</span></span>
<span class="line"><span class="token comment"># 如果中心点是边界，它与周围像素点差异的幅度会较大，Laplacian算子根据此特点可以把边界识别出来</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Sobel算子</p><p><img src="http://imagebed.krins.cloud/api/image/ND4XBDR8.png#pic_center" alt="尺寸为3的Sobel算子"></p><p>Scharr算子</p><p><img src="http://imagebed.krins.cloud/api/image/2PTTP0T2.png" alt="Scharr算子"></p><p>Laplacian算子</p><p><img src="http://imagebed.krins.cloud/api/image/TN8X4ZH2.png#pic_center" alt="Laplacian算子"></p><p>各算子效果对比</p><p><img src="http://imagebed.krins.cloud/api/image/HPXZ0BD0.png#pic_center" alt="三种算子边缘识别效果对比"></p><h4 id="canny边缘检测" tabindex="-1"><a class="header-anchor" href="#canny边缘检测"><span>canny边缘检测</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># canny边缘检测</span></span>
<span class="line">cv<span class="token punctuation">.</span>Canny<span class="token punctuation">(</span>img<span class="token punctuation">,</span>minVal<span class="token punctuation">,</span>maxVal<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 阈值整体设的小，检测出的边缘更细致</span></span>
<span class="line"><span class="token comment"># 阈值整体设的大，检测出的边缘更干净</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="图像重采样" tabindex="-1"><a class="header-anchor" href="#图像重采样"><span>图像重采样</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 上采样</span></span>
<span class="line"><span class="token comment"># 尺寸变大但分辨率不会提升</span></span>
<span class="line">cv<span class="token punctuation">.</span>pyrUp<span class="token punctuation">(</span>img<span class="token punctuation">,</span> dstsize<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> borderType<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># dstsize：表示输出图像的大小</span></span>
<span class="line"><span class="token comment"># borderType：表示图像边界的处理方式</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 下采样</span></span>
<span class="line"><span class="token comment"># 操作一次一个 MxN 的图像就变成了一个 M/2xN/2 的图像</span></span>
<span class="line">cv<span class="token punctuation">.</span>pyrDown<span class="token punctuation">(</span>img<span class="token punctuation">,</span> dstsize<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> borderType<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="轮廓检测" tabindex="-1"><a class="header-anchor" href="#轮廓检测"><span>轮廓检测</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 轮廓检测</span></span>
<span class="line"></span>
<span class="line">cv<span class="token punctuation">.</span>findContours<span class="token punctuation">(</span>img<span class="token punctuation">,</span>mode<span class="token punctuation">,</span>method<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># mode：轮廓检索模式</span></span>
<span class="line"><span class="token comment"># RETR_EXTERNAL ：只检索最外面的轮廓。</span></span>
<span class="line"><span class="token comment"># RETR_LIST：检索所有的轮廓，并将其保存到一条链表当中。</span></span>
<span class="line"><span class="token comment"># RETR_CCOMP：检索所有的轮廓，并将他们组织为两层：顶层是各部分的外部边界，第二层是空洞的边界。</span></span>
<span class="line"><span class="token comment"># RETR_TREE：检索所有的轮廓，并重构嵌套轮廓的整个层次。( 最常用 )</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#method：轮廓逼近方法</span></span>
<span class="line"><span class="token comment"># CHAIN_APPROX_NONE：以Freeman链码的方式输出整个轮廓</span></span>
<span class="line"><span class="token comment"># CHAIN_APPROX_SIMPLE：只保留每条线的终点部分</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#为了更高的准确度，把图像转为二值图</span></span>
<span class="line">img <span class="token operator">=</span> cv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">&#39;PATH&#39;</span><span class="token punctuation">)</span></span>
<span class="line">gray <span class="token operator">=</span> cv<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span></span>
<span class="line">ret<span class="token punctuation">,</span> thresh <span class="token operator">=</span> cv<span class="token punctuation">.</span>threshold<span class="token punctuation">(</span>gray<span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> cv<span class="token punctuation">.</span>THRESH_BINARY<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检测轮廓</span></span>
<span class="line">contours<span class="token punctuation">,</span> hierarchy <span class="token operator">=</span> cv<span class="token punctuation">.</span>findContours<span class="token punctuation">(</span>thresh<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>RETR_TREE<span class="token punctuation">,</span> cv<span class="token punctuation">.</span>CHAIN_APPOX_NONE<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># contours返回轮廓点信息</span></span>
<span class="line"><span class="token comment"># hierarchy返回轮廓层级结构</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 绘制轮廓</span></span>
<span class="line"><span class="token comment"># 若不用拷贝后的，而是用原图画轮廓，则画轮廓图绘把原始的输入图像重写，覆盖掉</span></span>
<span class="line"><span class="token comment"># 传入参数：绘制图像、轮廓信息、轮廓索引(-1则自适应，画所有轮廓)，线条颜色(BGR模式)，线条厚度</span></span>
<span class="line">draw_img <span class="token operator">=</span> img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">res <span class="token operator">=</span> cv<span class="token punctuation">.</span>drawContours<span class="token punctuation">(</span>draw_img<span class="token punctuation">,</span> contours<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 轮廓特征提取</span></span>
<span class="line">cnt <span class="token operator">=</span> contours<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment"># 通过轮廓索引，拿到该索引对应的轮廓特征</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>cv<span class="token punctuation">.</span>contourArea<span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 打印该轮廓的面积</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>cv<span class="token punctuation">.</span>arcLength<span class="token punctuation">(</span>cnt<span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 打印该轮廓的周长，True表示闭合的</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 轮廓近似</span></span>
<span class="line"><span class="token comment"># 正常轮廓展示是最右边的图，但是当我们需要轮廓没有那么不规则，而是想要轮廓近似成规则的形状，这就叫轮廓近似，近似成下图中中间图像的轮廓。</span></span>
<span class="line"><span class="token comment"># 一条呈抛物线的曲线的端点为 A、B 两点，取曲线上到直线 AB 距离最大的点，该点为 C 点，若 C 点到直线的距离小于设置的阈值，则可以把直线 AB 当做曲线的近似，若 C 点到直线的距离大于设置的阈值，那么曲线不能用直线 AB 来近似，而 AC 曲线可能用 AC 直线来代替、BC曲线可能用 BC 直线来代替。再通过阈值来判断是否可以代替。</span></span>
<span class="line">epsilon <span class="token operator">=</span> <span class="token number">0.1</span> <span class="token operator">*</span> cv<span class="token punctuation">.</span>arcLength<span class="token punctuation">(</span>cnt<span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># 周长的百分比，这里用 0.1 的周长作阈值</span></span>
<span class="line">approx <span class="token operator">=</span> cv<span class="token punctuation">.</span>approxPolyDP<span class="token punctuation">(</span>cnt<span class="token punctuation">,</span>epsilon<span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># 第二个参数为阈值</span></span>
<span class="line">draw_img <span class="token operator">=</span> img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">res <span class="token operator">=</span> cv<span class="token punctuation">.</span>drawContours<span class="token punctuation">(</span>draw_img<span class="token punctuation">,</span><span class="token punctuation">[</span>approx<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 绘制轮廓外接矩形</span></span>
<span class="line">x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>w<span class="token punctuation">,</span>h <span class="token operator">=</span> cv<span class="token punctuation">.</span>boundingRect<span class="token punctuation">(</span>cnt<span class="token punctuation">)</span> <span class="token comment"># 得到矩形四个坐标点的相关信息</span></span>
<span class="line">img <span class="token operator">=</span> cv<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>x<span class="token operator">+</span>w<span class="token punctuation">,</span>y<span class="token operator">+</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token comment"># 用对角坐标绘制矩形</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 绘制轮廓外接圆</span></span>
<span class="line">draw_img <span class="token operator">=</span> img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span>redius <span class="token operator">=</span> cv<span class="token punctuation">.</span>minEnclosingCircle<span class="token punctuation">(</span>cnt<span class="token punctuation">)</span> <span class="token comment"># 得到外接圆圆心和半径</span></span>
<span class="line"><span class="token comment"># 将数据转为整数</span></span>
<span class="line">center <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">redius <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>redius<span class="token punctuation">)</span></span>
<span class="line">img <span class="token operator">=</span> cv<span class="token punctuation">.</span>circle<span class="token punctuation">(</span>draw_img<span class="token punctuation">,</span>center<span class="token punctuation">,</span>redius<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token comment"># 绘制圆</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>轮廓是否近似对比</p><p><img src="http://imagebed.krins.cloud/api/image/N20LLPJ8.png#pic_center" alt="轮廓近似示意"></p><p>轮廓近似示意图</p><p><img src="http://imagebed.krins.cloud/api/image/0RRB0V6X.png#pic_center" alt="轮廓近似阈值示意"></p><h4 id="图像匹配" tabindex="-1"><a class="header-anchor" href="#图像匹配"><span>图像匹配</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 模板匹配</span></span>
<span class="line">dct <span class="token operator">=</span> cv<span class="token punctuation">.</span>matchTemplate<span class="token punctuation">(</span>img<span class="token punctuation">,</span>template<span class="token punctuation">,</span>methods<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 计算A图每个区域与B图(模板)的相关性</span></span>
<span class="line"><span class="token comment"># 模板在原图像上从原点开始滑动，计算模板与（图像被模板覆盖的地方）的差别程度(例如值127与值190的区别)，这个差别程度的计算方法在opencv里有6种，然后将每次计算的结果放入一个矩阵里，作为结果输出。</span></span>
<span class="line"><span class="token comment"># 假如原图形是AxB大小，而模板是axb大小，则输出结果的矩阵是(A-a+1)x(B-b+1)。</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 模板匹配计算方式6种方式 ( 用归一化后的方式更好一些 )：</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># TM_SQDIFF：计算平方不同，计算出来的值越小，越相关。</span></span>
<span class="line"><span class="token comment"># TM_CCORR：计算相关性，计算出来的值越大，越相关。</span></span>
<span class="line"><span class="token comment"># TM_CCOEFF：计算相关系数，计算出来的值越大，越相关。</span></span>
<span class="line"><span class="token comment"># TM_SQDIFF_NORMED：计算归一化平方不同，计算出来的值越接近0，越相关。</span></span>
<span class="line"><span class="token comment"># TM_CCORR_NORMED：计算归一化相关性，计算出来的值越接近1，越相关。</span></span>
<span class="line"><span class="token comment"># TM_CCOEFF_NORMED：计算归一化相关系数，计算出来的值越接近1，越相关。</span></span>
<span class="line"><span class="token comment"># 具体公式链接：https://docs.opencv.org/3.3.1/df/dfb/group__imgproc__object.html#ga3a7850640f1fe1f58fe91a2d7583695d</span></span>
<span class="line"></span>
<span class="line">min_val<span class="token punctuation">,</span> max_val<span class="token punctuation">,</span> min_loc<span class="token punctuation">,</span> max_loc <span class="token operator">=</span> cv<span class="token punctuation">.</span>minMaxLoc<span class="token punctuation">(</span>img<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 寻找图像最大最小值及其坐标</span></span>
<span class="line"></span>
<span class="line">h<span class="token punctuation">,</span> w <span class="token operator">=</span> template<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token comment"># 获得模板的宽和高</span></span>
<span class="line">methods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;cv.TM_CCOEFF&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;cv.TM_CCOEFF_NORMED&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;cv.TM_CCORR&#39;</span><span class="token punctuation">,</span>      <span class="token string">&#39;cv.TM_CCORR_NORMED&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;cv.TM_SQDIFF&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;cv.TM_SQDIFF_NORMED&#39;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token comment">#匹配单个对象</span></span>
<span class="line"><span class="token keyword">for</span> meth <span class="token keyword">in</span> methods<span class="token punctuation">:</span></span>
<span class="line">    img2 <span class="token operator">=</span> img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># 匹配方法的真值</span></span>
<span class="line">    method <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>meth<span class="token punctuation">)</span> <span class="token comment"># 提取字符串中的内容，不能用字符串的形式</span></span>
<span class="line">    <span class="token keyword">print</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span></span>
<span class="line">    res <span class="token operator">=</span> cv<span class="token punctuation">.</span>matchTemplate<span class="token punctuation">(</span>img<span class="token punctuation">,</span>template<span class="token punctuation">,</span>method<span class="token punctuation">)</span></span>
<span class="line">    min_val<span class="token punctuation">,</span> max_val<span class="token punctuation">,</span> min_loc<span class="token punctuation">,</span> max_loc <span class="token operator">=</span> cv<span class="token punctuation">.</span>minMaxLoc<span class="token punctuation">(</span>res<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 如果是平方差匹配 TM_SQDIFF 或归一化平方差匹配 TM_SQDIFF_NORMED,取最小值</span></span>
<span class="line">    <span class="token keyword">if</span> method <span class="token keyword">in</span> <span class="token punctuation">[</span>cv<span class="token punctuation">.</span>TM_SQDIFF<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>TM_SQDIFF_NORMED<span class="token punctuation">]</span><span class="token punctuation">:</span></span>
<span class="line">        top_left <span class="token operator">=</span> min_loc</span>
<span class="line">    <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">        top_left <span class="token operator">=</span> max_loc</span>
<span class="line">    bottom_right <span class="token operator">=</span> <span class="token punctuation">(</span>top_left<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>w<span class="token punctuation">,</span>top_left<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>h<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 画矩形</span></span>
<span class="line">    cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img2<span class="token punctuation">,</span>top_left<span class="token punctuation">,</span>bottom_right<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">121</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>res<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">&#39;gray&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 隐藏坐标轴</span></span>
<span class="line">    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">122</span><span class="token punctuation">)</span><span class="token punctuation">,</span>plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img2<span class="token punctuation">,</span>cmap<span class="token operator">=</span><span class="token string">&#39;gray&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    plt<span class="token punctuation">.</span>suptitle<span class="token punctuation">(</span>meth<span class="token punctuation">)</span></span>
<span class="line">    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line"><span class="token comment"># 匹配多个对象</span></span>
<span class="line">res <span class="token operator">=</span> cv<span class="token punctuation">.</span>matchTemplate<span class="token punctuation">(</span>img_gray<span class="token punctuation">,</span> template<span class="token punctuation">,</span> cv<span class="token punctuation">.</span>TM_CCOEFF_NORMED<span class="token punctuation">)</span> <span class="token comment"># res 是返回每一个小块窗口得到的结果值,选用相关系数方式进行匹配</span></span>
<span class="line">threshold <span class="token operator">=</span> <span class="token number">0.8</span> <span class="token comment">#设置匹配度阈值为0.8，大于0.8的认为匹配成功</span></span>
<span class="line"><span class="token comment"># 取匹配程度大于 80% 的坐标</span></span>
<span class="line">loc <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>res <span class="token operator">&gt;=</span> threshold<span class="token punctuation">)</span> <span class="token comment"># np.where 使得返回 res 矩阵中值大于 0.8 的索引，即坐标</span></span>
<span class="line">img_rgb <span class="token operator">=</span> img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">i <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line"><span class="token comment"># zip函数为打包为元组的列表，例 a = [1,2,3] b = [4,5,6] zip(a,b) 为 [(1, 4), (2, 5), (3, 6)]    </span></span>
<span class="line"><span class="token keyword">for</span> pt <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>loc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># 当用 *b 作为传入参数时, b 可以为列表、元组、集合，zip使得元组中两个 numpy.array 进行配对   </span></span>
<span class="line">    bottom_right <span class="token operator">=</span> <span class="token punctuation">(</span>pt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> w<span class="token punctuation">,</span> pt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> h<span class="token punctuation">)</span></span>
<span class="line">    cv<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img_rgb<span class="token punctuation">,</span> pt<span class="token punctuation">,</span> bottom_right<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line">    i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span></span>
<span class="line"></span>
<span class="line">cv<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">&#39;img_rgb&#39;</span><span class="token punctuation">,</span>img_rgb<span class="token punctuation">)</span></span>
<span class="line">cv<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>各匹配方法对比</p><p><img src="http://imagebed.krins.cloud/api/image/608N0B20.png" alt="各方法单个对象匹配效果"></p><p>单图匹配多个模板效果</p><p><img src="http://imagebed.krins.cloud/api/image/8DLN6080.png" alt="匹配多个对象效果"></p><h4 id="图像直方图" tabindex="-1"><a class="header-anchor" href="#图像直方图"><span>图像直方图</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 图像直方图</span></span>
<span class="line">cv<span class="token punctuation">.</span>calcHist<span class="token punctuation">(</span>img<span class="token punctuation">,</span>channels<span class="token punctuation">,</span>mask<span class="token punctuation">,</span>histSize<span class="token punctuation">,</span>ranges<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># images：原图像的图像格式为 uint8 或 ﬂoat32。当传入函数时应该用中括号 [] 括来传入，例如[img]</span></span>
<span class="line"><span class="token comment"># channels：同样用中括号来传入，它会告诉函数统幅的哪幅灰度图的直方图。如果传入的图像是灰度图它的值就是 [0]，如果是彩色图像，那么传入的参数可以是 [0]、[1]、[2]，它们分别对应着 B、G、R 通道，每个通道的图像都是灰度图。</span></span>
<span class="line"><span class="token comment"># mask：掩模图像。统计整幅图像的直方图时就把它设为 None。但是如果你想统计图像的某一部分区域的直方图的，你就制作一个掩模图像并使用它。</span></span>
<span class="line"><span class="token comment"># histSize：BIN 的数目。也应用中括号括起来。</span></span>
<span class="line"><span class="token comment"># ranges: 统计的像素值范围，常为 [0-256]。</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 对于灰度图可以直接用pyplot的hist函数</span></span>
<span class="line">img <span class="token operator">=</span> cv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">&#39;PATH&#39;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># 0 表示灰度图</span></span>
<span class="line">plt<span class="token punctuation">.</span>hist<span class="token punctuation">(</span>img<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>bins<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token comment"># img.ravel()将 img 拉成一维数组</span></span>
<span class="line">plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看彩色图像各通道的直方图</span></span>
<span class="line">img <span class="token operator">=</span> cv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">&#39;PATH&#39;</span><span class="token punctuation">)</span></span>
<span class="line">color <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;b&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;g&#39;</span><span class="token punctuation">,</span><span class="token string">&#39;r&#39;</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token keyword">for</span> i<span class="token punctuation">,</span>col <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># enumerate() 函数用于将一个可遍历的数据对象(如列表、元组或字符串)组合为一个索引序列，同时列出数据和数据下标，一般用在 for 循环当中。</span></span>
<span class="line">    histr <span class="token operator">=</span> cv<span class="token punctuation">.</span>calcHist<span class="token punctuation">(</span><span class="token punctuation">[</span>img<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>histr<span class="token punctuation">,</span>color<span class="token operator">=</span>col<span class="token punctuation">)</span></span>
<span class="line">    plt<span class="token punctuation">.</span>xlim<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line"><span class="token comment"># 创建掩膜</span></span>
<span class="line">mask <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span></span>
<span class="line">mask<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">:</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">:</span><span class="token number">400</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">255</span></span>
<span class="line"><span class="token comment"># 掩膜与原图进行与操作</span></span>
<span class="line">masked_img <span class="token operator">=</span> cv<span class="token punctuation">.</span>bitwise_and<span class="token punctuation">(</span>img<span class="token punctuation">,</span>img<span class="token punctuation">,</span>mask <span class="token operator">=</span> mask<span class="token punctuation">)</span></span>
<span class="line">hist_mask <span class="token operator">=</span> cv<span class="token punctuation">.</span>calcHist<span class="token punctuation">(</span><span class="token punctuation">[</span>img<span class="token punctuation">]</span><span class="token punctuation">,</span>mask<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 直方图均衡化</span></span>
<span class="line"><span class="token comment"># 直方图均衡化：一般可以用来提升图片的色彩和亮度</span></span>
<span class="line"><span class="token comment"># 直方图均衡前是一个瘦高的统计图，直方图均衡后是一个矮胖的统计图</span></span>
<span class="line">equ <span class="token operator">=</span> cv<span class="token punctuation">.</span>equalizeHist<span class="token punctuation">(</span>img<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 自适应直方图均衡化</span></span>
<span class="line"><span class="token comment"># 可能由于直方图均衡导致丢失一些细节。所以可能切分成几个小块，局部做直方图均衡化，会比较好。</span></span>
<span class="line"><span class="token comment"># 切分成几个小块之后，可能会导致一个现象，每个格子都会产生一个边界，opencv是对每个格子的边界进行线性插值处理。</span></span>
<span class="line">cv<span class="token punctuation">.</span>createCLAHE<span class="token punctuation">(</span>clipLimit<span class="token punctuation">,</span>tileGridSize<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># clipLimit 颜色对比度的阈值。</span></span>
<span class="line"><span class="token comment"># titleGridSize 进行像素均衡化的网格大小，即在多少网格下进行直方图的均衡化操作。</span></span>
<span class="line">clahe <span class="token operator">=</span> cv<span class="token punctuation">.</span>createCLAHE<span class="token punctuation">(</span>clipLimit<span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">,</span>tileGridSize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 生成自适应均衡化方法</span></span>
<span class="line">img_clahe <span class="token operator">=</span> clahe<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token comment"># 将方法应用到图像</span></span>
<span class="line"><span class="token comment"># 该函数一次只能处理一个通道，要处理彩色图像需先拆开分别处理再合并</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://imagebed.krins.cloud/api/image/BF0D02TD.png" alt="灰度图的直方图"></p><p><img src="http://imagebed.krins.cloud/api/image/644XLJD2.png" alt="彩色图的直方图"></p><p><img src="http://imagebed.krins.cloud/api/image/NTD6B0X8.png" alt="直方图均衡化"></p><h4 id="图像傅里叶变换" tabindex="-1"><a class="header-anchor" href="#图像傅里叶变换"><span>图像傅里叶变换</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 图像傅里叶变换</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 频谱图上的点和原图像上的点并不是一一对应的关系，频谱图上的每个点都代表了原图像的全局信息，频谱图上的点反映的是原图像中具有该灰度变化快慢规律的图像区域(可能不止一个)及其灰度峰值（亮暗）信息。</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 高频：变化剧烈的分量，增强高频使细节更明显</span></span>
<span class="line"><span class="token comment"># 低频：变化缓慢的分量，增强低频使边界模糊</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># opencv 中主要就是 cv2.dft() 执行傅里叶变换到频域中 和 cv2.idft() 执行逆傅里叶变换，输入图像需要先转换成 np.float32 格式。</span></span>
<span class="line"><span class="token comment"># 得到的结果中频率为 0 的部分会在左上角，通常要转换到中心位置，可以通过 shift 变换来实现。</span></span>
<span class="line"><span class="token comment"># cv2.dft() 返回的结果是双通道的 ( 实部，虚部 )，通常还需要转换成图像格式才能展示(0,255)像素值。</span></span>
<span class="line"></span>
<span class="line">img_float <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span>img<span class="token punctuation">)</span></span>
<span class="line">dft <span class="token operator">=</span> cv<span class="token punctuation">.</span>dft<span class="token punctuation">(</span>img_float<span class="token punctuation">,</span> flags <span class="token operator">=</span> cv<span class="token punctuation">.</span>DFT_COMPLEX_OUTPUT<span class="token punctuation">)</span><span class="token comment"># 输出两个通道，分别为实部和虚部</span></span>
<span class="line">dft_shift <span class="token operator">=</span> np<span class="token punctuation">.</span>fft<span class="token punctuation">.</span>fftshift<span class="token punctuation">(</span>dft<span class="token punctuation">)</span></span>
<span class="line">magnitude_spectrum <span class="token operator">=</span> <span class="token number">20</span> <span class="token operator">*</span> np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>cv<span class="token punctuation">.</span>magnitude<span class="token punctuation">(</span>dft_shift<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dft_shift<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">#cv.magnitude用来计算二维矢量的幅值，相当于求模，取20倍log进行缩小</span></span>
<span class="line"></span>
<span class="line">rows<span class="token punctuation">,</span>cols <span class="token operator">=</span> img<span class="token punctuation">.</span>shape</span>
<span class="line">crow<span class="token punctuation">,</span>ccol <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>rows<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">int</span><span class="token punctuation">(</span>cols<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># 获得图像中心位置方便制作滤波器</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 高通滤波</span></span>
<span class="line">mask <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span>rows<span class="token punctuation">,</span>cols<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span></span>
<span class="line">mask<span class="token punctuation">[</span>crow<span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">:</span>crow<span class="token operator">+</span><span class="token number">30</span><span class="token punctuation">,</span>ccol<span class="token operator">-</span><span class="token number">30</span><span class="token punctuation">:</span>ccol<span class="token operator">+</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">#低频部分置0，去除掉</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># IDFT </span></span>
<span class="line"><span class="token comment"># 滤波后将频谱移回原来的位置后逆傅里叶变换，得到的还是实部和虚部，再次求模</span></span>
<span class="line">hp_shift <span class="token operator">=</span> dft_shift <span class="token operator">*</span> mask</span>
<span class="line">hp_ishift <span class="token operator">=</span> np<span class="token punctuation">.</span>fft<span class="token punctuation">.</span>ifftshift<span class="token punctuation">(</span>hp_shift<span class="token punctuation">)</span></span>
<span class="line">img_back <span class="token operator">=</span> cv<span class="token punctuation">.</span>idft<span class="token punctuation">(</span>hp_ishift<span class="token punctuation">)</span></span>
<span class="line">img_back <span class="token operator">=</span> cv<span class="token punctuation">.</span>magnitude<span class="token punctuation">(</span>img_back<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 高通滤波后也能获得轮廓信息</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://imagebed.krins.cloud/api/image/JPH2468F.png#pic_center" alt="高通滤波"></p><h4 id="图像透视变换" tabindex="-1"><a class="header-anchor" href="#图像透视变换"><span>图像透视变换</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">M <span class="token operator">=</span> cv<span class="token punctuation">.</span>getPerspectiveTransform<span class="token punctuation">(</span>coordinate_origin<span class="token punctuation">,</span> coordinate_new<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 获得变换矩阵</span></span>
<span class="line"><span class="token comment"># coordinate_origin：原图坐标</span></span>
<span class="line"><span class="token comment"># coordinate_new：新图坐标</span></span>
<span class="line">img_new <span class="token operator">=</span> cv<span class="token punctuation">.</span>warpPerspective<span class="token punctuation">(</span>src<span class="token punctuation">,</span>M<span class="token punctuation">,</span>dsize<span class="token operator">=</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>flags<span class="token operator">=</span>INTER_LINEAR<span class="token punctuation">,</span>borderMode<span class="token operator">=</span>BORDER_CONSTANT<span class="token punctuation">,</span>borderValue<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># dsize为必要项，若设置的比转换后的图小，会从转换后的图左上角开始裁切</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="harris角点检测" tabindex="-1"><a class="header-anchor" href="#harris角点检测"><span>Harris角点检测</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># x,y方向都有大梯度变化的是角点</span></span>
<span class="line"><span class="token comment"># x或y方向有大梯度变化的是边界</span></span>
<span class="line"><span class="token comment"># 否则是平面</span></span>
<span class="line"></span>
<span class="line">dst <span class="token operator">=</span> cv<span class="token punctuation">.</span>cornerHarris<span class="token punctuation">(</span>img<span class="token punctuation">,</span>blockSize<span class="token punctuation">,</span>ksize<span class="token punctuation">,</span>k<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># img：数据类型为 ﬂoat32 的入图像。</span></span>
<span class="line"><span class="token comment"># blockSize：角点检测中指定区域的大小。</span></span>
<span class="line"><span class="token comment"># ksize：Sobel求导中使用的窗口大小。常用 3。</span></span>
<span class="line"><span class="token comment"># k：计算R值时的系数，取值参数为 [0.04,0.06]。常用 0.04。</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># dst大于最大值的1%即可判断为角点</span></span>
<span class="line"><span class="token comment"># 绘制角点</span></span>
<span class="line">img<span class="token punctuation">[</span>dst<span class="token operator">&gt;</span><span class="token number">0.01</span><span class="token operator">*</span>dst<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span></span>
<span class="line">show<span class="token punctuation">(</span>img<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="sift" tabindex="-1"><a class="header-anchor" href="#sift"><span>SIFT</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">sift <span class="token operator">=</span> cv2<span class="token punctuation">.</span>xfeatures2d<span class="token punctuation">.</span>SIFT_create<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 将 SIFT 算法实例化出来</span></span>
<span class="line">kp <span class="token operator">=</span> sift<span class="token punctuation">.</span>detect<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token comment"># 把图传进去，得到特征点、关键点</span></span>
<span class="line">kp<span class="token punctuation">,</span> des <span class="token operator">=</span> sift<span class="token punctuation">.</span>compute<span class="token punctuation">(</span>img<span class="token punctuation">,</span> kp<span class="token punctuation">)</span> <span class="token comment"># 计算特征向量</span></span>
<span class="line"><span class="token comment"># 也可以直接找关键点并计算特征向量</span></span>
<span class="line">kp<span class="token punctuation">,</span> des <span class="token operator">=</span> sift<span class="token punctuation">.</span>detectAndCompute<span class="token punctuation">(</span>img<span class="token punctuation">,</span>mask<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 画出关键点</span></span>
<span class="line">outImg <span class="token operator">=</span> cv2<span class="token punctuation">.</span>drawKeypoints<span class="token punctuation">(</span>img<span class="token punctuation">,</span> kp<span class="token punctuation">,</span> outImage<span class="token punctuation">,</span>color<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>flags<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># flags</span></span>
<span class="line"><span class="token comment"># DRAW_MATCHES_FLAGS_DEFAULT：</span></span>
<span class="line"><span class="token comment"># 只绘制特征点的坐标点，显示在图像上就是一个个小圆点，每个小圆点的圆心坐标都是特征点的坐标。</span></span>
<span class="line"><span class="token comment"># DRAW_MATCHES_FLAGS_DRAW_OVER_OUTIMG：</span></span>
<span class="line"><span class="token comment"># 函数不创建输出的图像，而是直接在输出图像变量空间绘制，要求本身输出图像变量就是一个初始化好了的，size与type都是已经初始化好的变量。</span></span>
<span class="line"><span class="token comment"># DRAW_MATCHES_FLAGS_NOT_DRAW_SINGLE_POINTS ：</span></span>
<span class="line"><span class="token comment"># 单点的特征点不被绘制。</span></span>
<span class="line"><span class="token comment"># DRAW_MATCHES_FLAGS_DRAW_RICH_KEYPOINTS：</span></span>
<span class="line"><span class="token comment"># 绘制特征点的时候绘制的是一个个带有方向的圆，这种方法同时显示图像的坐标，size和方向，是最能显示特征的一种绘制方式。</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="特征点匹配" tabindex="-1"><a class="header-anchor" href="#特征点匹配"><span>特征点匹配</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">BFMatcher <span class="token operator">=</span> cv<span class="token punctuation">.</span>BFMatcher<span class="token punctuation">(</span>normType<span class="token punctuation">,</span>crossCheck<span class="token punctuation">)</span> <span class="token comment"># 实例化匹配方法</span></span>
<span class="line"><span class="token comment"># normType：如 NORM_L1, NORM_L2, NORM_HAMMING, NORM_HAMMING2.           # NORM_L1 和 NORM_L2 更适用于 SIFT 和 SURF 描述子; </span></span>
<span class="line"><span class="token comment"># NORM_HAMMING 和 ORB、BRISK、BRIEF 一起使用；</span></span>
<span class="line"><span class="token comment"># NORM_HAMMING2 用于 WTA_K==3或4 的 ORB 描述子.        </span></span>
<span class="line"><span class="token comment"># crossCheck：默认为 False，其寻找每个查询描述子的 k 个最近邻. </span></span>
<span class="line"><span class="token comment"># 若值为 True，则 knnMatch() 算法 k=1，仅返回(i, j)的匹配结果，</span></span>
<span class="line"><span class="token comment"># 即集合A中的第 i 个描述子在集合B中的第 j 个描述子是最佳匹配. </span></span>
<span class="line"><span class="token comment"># 也就是说，两个集合中的两个描述子特征是互相匹配的. </span></span>
<span class="line"><span class="token comment"># 其提供连续的结果. </span></span>
<span class="line"><span class="token comment"># 当有足够的匹配项时，其往往能够找到最佳的匹配结果.</span></span>
<span class="line"></span>
<span class="line">matches <span class="token operator">=</span> BFMatcher<span class="token punctuation">.</span><span class="token keyword">match</span><span class="token punctuation">(</span>feature1<span class="token punctuation">,</span>feature2<span class="token punctuation">)</span> <span class="token comment"># 一对一配对</span></span>
<span class="line"></span>
<span class="line">matches <span class="token operator">=</span> BFMatcher<span class="token punctuation">.</span>knnMatch<span class="token punctuation">(</span>feature1<span class="token punctuation">,</span>feature2<span class="token punctuation">,</span>k<span class="token punctuation">)</span> <span class="token comment"># 一对k配对</span></span>
<span class="line"><span class="token comment"># 一对k配对还需过滤一下</span></span>
<span class="line"><span class="token comment"># 用比值判定，距离相差太远的不要</span></span>
<span class="line">matches <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token keyword">for</span> m<span class="token punctuation">,</span>n <span class="token keyword">in</span> matches<span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">if</span> m<span class="token punctuation">.</span>distance <span class="token operator">&lt;</span> <span class="token number">0.75</span><span class="token operator">*</span>n<span class="token punctuation">.</span>distance<span class="token punctuation">:</span></span>
<span class="line">        matches<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line"><span class="token comment"># 画出匹配特征</span></span>
<span class="line">img <span class="token operator">=</span> cv<span class="token punctuation">.</span>drawMatches<span class="token punctuation">(</span>img1<span class="token punctuation">,</span>kp1<span class="token punctuation">,</span>img2<span class="token punctuation">,</span>kp2<span class="token punctuation">,</span>matches<span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">,</span>flags<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 画出匹配结果. 其水平的堆叠两幅图像，并画出第一张图像到第二张图像的点连线，以表征最佳匹配. </span></span>
<span class="line"></span>
<span class="line">img <span class="token operator">=</span> cv<span class="token punctuation">.</span>drawMatchKnn<span class="token punctuation">(</span>img1<span class="token punctuation">,</span>kp1<span class="token punctuation">,</span>img2<span class="token punctuation">,</span>kp2<span class="token punctuation">,</span>good<span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">,</span>flags<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 画出 k 个最佳匹配.</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 如果需要更快速完成操作，可以尝试使用 cv2.FlannBasedMatcher。</span></span>
<span class="line"><span class="token comment"># 其是针对大规模高维数据集进行快速最近邻搜索的优化算法库.</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="混合高斯模型识别运动前景" tabindex="-1"><a class="header-anchor" href="#混合高斯模型识别运动前景"><span>混合高斯模型识别运动前景</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">fgbg <span class="token operator">=</span> cv2<span class="token punctuation">.</span>createBackgroundSubtractorMOG2<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 混合高斯模型实例化对象</span></span>
<span class="line">fgmask <span class="token operator">=</span> fgbg<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span>    <span class="token comment"># 将图像应用到混合高斯模型中进行判断</span></span>
<span class="line"><span class="token comment"># 该方法会拿前200帧作为背景训练</span></span>
<span class="line"><span class="token comment"># 该方法需保证镜头稳定、背景不变</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="光流估计" tabindex="-1"><a class="header-anchor" href="#光流估计"><span>光流估计</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line">nextPts<span class="token punctuation">,</span>status<span class="token punctuation">,</span>err <span class="token operator">=</span> cv2<span class="token punctuation">.</span>calcOpticalFlowPyrLK<span class="token punctuation">(</span>preImage<span class="token punctuation">,</span>nextImage<span class="token punctuation">,</span>prevPts<span class="token punctuation">,</span>winSize<span class="token punctuation">,</span>maxLevel<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># prevPts 待跟踪的特征点向量</span></span>
<span class="line"><span class="token comment"># winSize 搜索窗口的大小</span></span>
<span class="line"><span class="token comment"># maxLevel 最大的金字塔层数（平衡效率与精确度）</span></span>
<span class="line"><span class="token comment"># nextPts 输出跟踪特征点向量</span></span>
<span class="line"><span class="token comment"># status 特征点是否找到，找到的状态为1，未找到的状态为0</span></span>
<span class="line"></span>
<span class="line">p0 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>goodFeaturesToTrack<span class="token punctuation">(</span>old_gray<span class="token punctuation">,</span> mask <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> maxCorners<span class="token punctuation">,</span> qualityLevel<span class="token punctuation">,</span> minDistance<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 如果不限制角点最大数量，速度就会有些慢，达不到实时的效果</span></span>
<span class="line"><span class="token comment"># 品质因子会筛选角点，品质因子设置的越大，角点的特征值越大，得到的角点越少</span></span>
<span class="line"><span class="token comment"># 距离指在角点邻域继续检测，有比这个角点强的，就不要这个弱的了</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="项目1-简单数字识别" tabindex="-1"><a class="header-anchor" href="#项目1-简单数字识别"><span>项目1：简单数字识别</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token comment"># 简单数字OCR</span></span>
<span class="line"><span class="token comment"># 需要提前准备好数字匹配的模板</span></span>
<span class="line">template <span class="token operator">=</span> cv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">&#39;PATH&#39;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">template_binary <span class="token operator">=</span> cv<span class="token punctuation">.</span>threshold<span class="token punctuation">(</span>template<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span>cv<span class="token punctuation">.</span>THRESH_BINARY_INV<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token comment"># 将模板转为二值图像</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 将模板中的数字抠出来</span></span>
<span class="line">refCnts<span class="token punctuation">,</span>hierarchy <span class="token operator">=</span> cv<span class="token punctuation">.</span>findContours<span class="token punctuation">(</span>template_binary<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cv<span class="token punctuation">.</span>RETR_EXTERNAL<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>CHAIN_APPROX_SIMPLE<span class="token punctuation">)</span> <span class="token comment"># 边缘检测，只检测外边缘，只保留边缘终点值</span></span>
<span class="line">boundingBoxes <span class="token operator">=</span> <span class="token punctuation">[</span>cv<span class="token punctuation">.</span>boundingRect<span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> refCnts<span class="token punctuation">]</span> </span>
<span class="line"><span class="token punctuation">(</span>refCnts<span class="token punctuation">,</span>boundingBoxes<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>refCnts<span class="token punctuation">,</span>boundingBoxes<span class="token punctuation">)</span><span class="token punctuation">,</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> b<span class="token punctuation">:</span>b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 将每个轮廓从左到右编上序号</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 将数字与序号对应上</span></span>
<span class="line">dict_num<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span>c<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>boundingBoxes<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>w<span class="token punctuation">,</span>h<span class="token punctuation">)</span> <span class="token operator">=</span> cv<span class="token punctuation">.</span>boundingRect<span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token comment"># 获得各轮廓的起点以及宽高</span></span>
<span class="line">    roi <span class="token operator">=</span> ref<span class="token punctuation">[</span>y<span class="token punctuation">:</span>y<span class="token operator">+</span>h<span class="token punctuation">,</span>x<span class="token punctuation">:</span>x<span class="token operator">+</span>w<span class="token punctuation">]</span></span>
<span class="line">    roi <span class="token operator">=</span> cv<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>roi<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">58</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 将图像调整到合适大小</span></span>
<span class="line">    dict_num<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> roi</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置卷积核</span></span>
<span class="line">rectKernel <span class="token operator">=</span> cv<span class="token punctuation">.</span>getStructuringElement<span class="token punctuation">(</span>cv<span class="token punctuation">.</span>MORPH_RECT<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">sqKernel <span class="token operator">=</span> cv<span class="token punctuation">.</span>getStructuringElement<span class="token punctuation">(</span>cv<span class="token punctuation">.</span>MORPH_RECT<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># cv.getStructuringElement还可以生成椭圆形(cv.MORPH_ELLIPSE)或十字形(cv.MORPH_CROSS)的卷积核</span></span>
<span class="line"></span>
<span class="line">img <span class="token operator">=</span> cv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">&#39;PATH&#39;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># 读取OCR图像</span></span>
<span class="line"></span>
<span class="line">tophat <span class="token operator">=</span> cv<span class="token punctuation">.</span>morphologyEx<span class="token punctuation">(</span>img<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>MORPH_TOPHAT<span class="token punctuation">,</span>rectKernal<span class="token punctuation">)</span><span class="token comment"># 用礼帽操作突出图像更亮的区域</span></span>
<span class="line"><span class="token comment">#计算图像梯度并归一化进行边缘检测</span></span>
<span class="line">gradX <span class="token operator">=</span> cv<span class="token punctuation">.</span>Sobel<span class="token punctuation">(</span>tophat<span class="token punctuation">,</span>ddepth<span class="token operator">=</span>cv<span class="token punctuation">.</span>CV_32F<span class="token punctuation">,</span>dx<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>dy<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>ksize<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span></span>
<span class="line">gradX <span class="token operator">=</span> np<span class="token punctuation">.</span>absolute<span class="token punctuation">(</span>gradX<span class="token punctuation">)</span></span>
<span class="line">minVal<span class="token punctuation">,</span>maxVal <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>gradX<span class="token punctuation">)</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>gradX<span class="token punctuation">)</span></span>
<span class="line">gradX <span class="token operator">=</span> <span class="token number">255</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gradX <span class="token operator">-</span> minVal<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>maxVal <span class="token operator">-</span> minVal<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">gradY <span class="token operator">=</span> cv<span class="token punctuation">.</span>Sobel<span class="token punctuation">(</span>tophat<span class="token punctuation">,</span>ddepth<span class="token operator">=</span>cv<span class="token punctuation">.</span>CV_32F<span class="token punctuation">,</span>dx<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>dy<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>ksize<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span></span>
<span class="line">gradY <span class="token operator">=</span> np<span class="token punctuation">.</span>absolute<span class="token punctuation">(</span>gradY<span class="token punctuation">)</span></span>
<span class="line">minVal<span class="token punctuation">,</span>maxVal <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>gradY<span class="token punctuation">)</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>gradY<span class="token punctuation">)</span></span>
<span class="line">gradY <span class="token operator">=</span> <span class="token number">255</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gradY <span class="token operator">-</span> minVal<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>maxVal <span class="token operator">-</span> minVal<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">gradXY <span class="token operator">=</span> cv<span class="token punctuation">.</span>addWeighted<span class="token punctuation">(</span>gradX<span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span>gradY<span class="token punctuation">,</span><span class="token number">0.5</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">gradXY <span class="token operator">=</span> np<span class="token punctuation">.</span>uint8<span class="token punctuation">(</span>gradXY<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 闭操作（先膨胀，再腐蚀），将要识别的数字区域连在一起</span></span>
<span class="line">img_close <span class="token operator">=</span> cv<span class="token punctuation">.</span>morphologyEx<span class="token punctuation">(</span>gradXY<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>MORPH_CLOSE<span class="token punctuation">,</span>rectKernel<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># THRESH_OTSU会自动寻找合适的阈值，适合双峰型图像，需把阈值参数设为0</span></span>
<span class="line">gradXY_thresh <span class="token operator">=</span> cv<span class="token punctuation">.</span>threshold<span class="token punctuation">(</span>gradXY<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span>cv<span class="token punctuation">.</span>THRESH_OTSU<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token comment"># 再做一次闭操作把区域内的东西涂掉</span></span>
<span class="line">img_close <span class="token operator">=</span> cv<span class="token punctuation">.</span>morpholohyEx<span class="token punctuation">(</span>gradXY_thresh<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>MORPH_CLOSE<span class="token punctuation">,</span>rectKernel<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 计算轮廓</span></span>
<span class="line">imgCnts<span class="token punctuation">,</span>hierarchy <span class="token operator">=</span> cv<span class="token punctuation">.</span>findContours<span class="token punctuation">(</span>img_close<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cv<span class="token punctuation">.</span>RETR_EXTERNAL<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>CHAIN_APPROX_SIMPLE<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">cur_img <span class="token operator">=</span> img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">cv<span class="token punctuation">.</span>drawContours<span class="token punctuation">(</span>cur_img<span class="token punctuation">,</span>imgCnts<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 遍历轮廓，把无关轮廓清掉</span></span>
<span class="line">locs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span>c<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>imgCnts<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>w<span class="token punctuation">,</span>h<span class="token punctuation">)</span> <span class="token operator">=</span> cv<span class="token punctuation">.</span>boundingRect<span class="token punctuation">(</span>c<span class="token punctuation">)</span></span>
<span class="line">    r <span class="token operator">=</span> w <span class="token operator">/</span> h</span>
<span class="line">    <span class="token keyword">if</span> r <span class="token operator">&gt;</span> <span class="token number">2.5</span> <span class="token keyword">and</span> r <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">&gt;</span> <span class="token number">40</span> <span class="token keyword">and</span> w <span class="token operator">&lt;</span><span class="token number">55</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>h <span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token keyword">and</span> h <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span></span>
<span class="line">        	locs<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>w<span class="token punctuation">,</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 符合条件的留下</span></span>
<span class="line">locs <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>locs<span class="token punctuation">,</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 将轮廓从左到右排序</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 开始OCR</span></span>
<span class="line">output <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token comment"># 提取每个框</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">(</span>Gx<span class="token punctuation">,</span>Gy<span class="token punctuation">,</span>Gw<span class="token punctuation">,</span>Gh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>locs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    groupOutput <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    detect <span class="token operator">=</span> img<span class="token punctuation">[</span>Gy<span class="token operator">-</span><span class="token number">5</span>：Gy<span class="token operator">+</span>Gh<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">,</span>Gx<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span>Gx<span class="token operator">+</span>Gw<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token comment"># 提取每组数据</span></span>
<span class="line">    detect <span class="token operator">=</span> cv<span class="token punctuation">.</span>threshold<span class="token punctuation">(</span>detect<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span>cv<span class="token punctuation">.</span>THRESH_OTSU<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line">    detectCnts<span class="token punctuation">,</span>hierarchy <span class="token operator">=</span> cv<span class="token punctuation">.</span>findContours<span class="token punctuation">(</span>detect<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cv<span class="token punctuation">.</span>RETR_EXTERNAL<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>CHAIN_APPROX_SIMPLE<span class="token punctuation">)</span></span>
<span class="line">    boundingBoxes_detect <span class="token operator">=</span> <span class="token punctuation">[</span>cv<span class="token punctuation">.</span>boundingRect<span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> detectCnts<span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">(</span>detectCnts<span class="token punctuation">,</span>boundingBoxes_detect<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>detectCnts<span class="token punctuation">,</span>boundingBoxes_detect<span class="token punctuation">)</span><span class="token punctuation">,</span>key <span class="token operator">=</span> <span class="token keyword">lambda</span> x <span class="token punctuation">:</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># 匹配每个框内的数字</span></span>
<span class="line">    <span class="token keyword">for</span> c <span class="token keyword">in</span> detectCnts<span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>w<span class="token punctuation">,</span>h<span class="token punctuation">)</span> <span class="token operator">=</span> cv<span class="token punctuation">.</span>boundingRect<span class="token punctuation">(</span>c<span class="token punctuation">)</span></span>
<span class="line">        roi <span class="token operator">=</span> detect<span class="token punctuation">[</span>y<span class="token punctuation">:</span>y<span class="token operator">+</span>h<span class="token punctuation">,</span>x<span class="token punctuation">:</span>x<span class="token operator">+</span>w<span class="token punctuation">]</span></span>
<span class="line">        roi <span class="token operator">=</span> cv<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>roi<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">57</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment"># 将数字与模板一一匹配找到匹配度最高的</span></span>
<span class="line">        scores <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span>num_ROI<span class="token punctuation">)</span> <span class="token keyword">in</span> dict_num<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            res <span class="token operator">=</span> cv<span class="token punctuation">.</span>matchTemplate<span class="token punctuation">(</span>roi<span class="token punctuation">,</span>num_ROI<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>TM_CCOEFF_NORMED<span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment"># scores[num] = max(res)</span></span>
<span class="line">            <span class="token punctuation">(</span>_<span class="token punctuation">,</span>score<span class="token punctuation">,</span>_<span class="token punctuation">,</span>_<span class="token punctuation">)</span> <span class="token operator">=</span> cv<span class="token punctuation">.</span>minMaxLoc<span class="token punctuation">(</span>res<span class="token punctuation">)</span></span>
<span class="line">            scores<span class="token punctuation">.</span>append<span class="token punctuation">(</span>score<span class="token punctuation">)</span></span>
<span class="line">        groupOutput<span class="token punctuation">.</span>append<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>scores<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line">    </span>
<span class="line">    cv<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>img<span class="token punctuation">,</span><span class="token punctuation">(</span>Gx<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span>Gy<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>Gx<span class="token operator">+</span>Gw<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">,</span>Gy<span class="token operator">+</span>Gh<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line">    cv<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>img<span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>groupOutput<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>Gx<span class="token punctuation">,</span>Gy<span class="token operator">-</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>cv<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span><span class="token number">0.65</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># cv.putText(img,text,origin(leftBottomCorner),fontFace,fontScale,color,thickness[,lineType=None])</span></span>
<span class="line">    output<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>groupOutput<span class="token punctuation">)</span><span class="token comment">#用extend将结果合并到output的末尾</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>读取模板图像</p><p><img src="http://imagebed.krins.cloud/api/image/6J22D28L.png" alt="模板"></p><p>图像二值化</p><p><img src="http://imagebed.krins.cloud/api/image/NB46404L.png" alt="模板二值化方便轮廓检测"></p><p>检测轮廓</p><p><img src="http://imagebed.krins.cloud/api/image/2HL42BN0.png" alt="模板外轮廓"></p><p>读取识别图像</p><p><img src="http://imagebed.krins.cloud/api/image/VFTNL682.png" alt="检测图像"></p><p>将灰度图用礼帽操作简单提亮一下数字</p><p><img src="http://imagebed.krins.cloud/api/image/RDZ8T648.png" alt="礼帽操作提亮"></p><p>计算梯度（图片是只算了X梯度）</p><p><img src="http://imagebed.krins.cloud/api/image/40PPRLNF.png" alt="计算梯度检测边缘"></p><p>闭操作将数字连在一起</p><p><img src="http://imagebed.krins.cloud/api/image/DVDD6026.png" alt="闭操作使数字连在一起"></p><p>二值化后再次闭操作将区域内的黑点涂掉</p><p><img src="http://imagebed.krins.cloud/api/image/N08D222H.png" alt="二值化后再次闭操作把区域内东西涂掉"></p><p>检测图像的轮廓</p><p><img src="http://imagebed.krins.cloud/api/image/LTB6B68D.png" alt="检测到的轮廓"></p><p>剃掉不识别的区域后逐个识别</p><p><img src="http://imagebed.krins.cloud/api/image/FVVX0BB4.png" alt="OCR结果"></p><h4 id="项目2-复杂ocr" tabindex="-1"><a class="header-anchor" href="#项目2-复杂ocr"><span>项目2：复杂OCR</span></a></h4><ol><li>图像预处理</li><li>边缘检测</li><li>轮廓检测</li><li>轮廓近似</li><li>透视变换</li><li>OCR识别</li><li>展示结果</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">import</span> cv2 <span class="token keyword">as</span> cv</span>
<span class="line"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np</span>
<span class="line"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt</span>
<span class="line"><span class="token keyword">import</span> pytesseract</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">plt_show</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">if</span> image<span class="token punctuation">.</span>ndim <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span></span>
<span class="line">        plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">,</span> cmap<span class="token operator">=</span><span class="token string">&#39;gray&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">        plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>cv<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>image<span class="token punctuation">,</span> cv<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">cv_show</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    cv<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">&quot;img&quot;</span><span class="token punctuation">,</span> image<span class="token punctuation">)</span></span>
<span class="line">    cv<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">    cv<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 将页面四个点从左上顺时针排序</span></span>
<span class="line"><span class="token comment"># 每个坐标求和，最小为左上，最大为右下</span></span>
<span class="line"><span class="token comment"># 每个坐标求差，最小为右上，最大为左下</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">orderPoints</span><span class="token punctuation">(</span>cnts<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    rect <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span></span>
<span class="line">    s <span class="token operator">=</span> <span class="token punctuation">(</span>screenCnt<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">    rect<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> cnts<span class="token punctuation">[</span>np<span class="token punctuation">.</span>argmin<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line">    rect<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> cnts<span class="token punctuation">[</span>np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line">    d <span class="token operator">=</span> np<span class="token punctuation">.</span>diff<span class="token punctuation">(</span>cnts<span class="token punctuation">)</span></span>
<span class="line">    rect<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> cnts<span class="token punctuation">[</span>np<span class="token punctuation">.</span>argmin<span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line">    rect<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> cnts<span class="token punctuation">[</span>np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">return</span> rect</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 透视变换函数</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">perspectiveTransform</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> cnts<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># 获取要变换的坐标</span></span>
<span class="line">    <span class="token punctuation">(</span>tl<span class="token punctuation">,</span> tr<span class="token punctuation">,</span> br<span class="token punctuation">,</span> bl<span class="token punctuation">)</span> <span class="token operator">=</span> cnts</span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 计算输入的w和h</span></span>
<span class="line">    widthA <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>br<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> bl<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>br<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> bl<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    widthB <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> tl<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> tl<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    maxWidth <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>widthA<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>widthB<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    heightA <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> br<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> br<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    heightB <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tl<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> bl<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tl<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> bl<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    maxHeight <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>heightA<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>heightB<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    dst <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">[</span>maxWidth <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">[</span>maxWidth <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> maxHeight <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> maxHeight <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">&#39;float32&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 计算变换矩阵</span></span>
<span class="line">    M <span class="token operator">=</span> cv<span class="token punctuation">.</span>getPerspectiveTransform<span class="token punctuation">(</span>cnts<span class="token punctuation">,</span> dst<span class="token punctuation">)</span></span>
<span class="line">    warped <span class="token operator">=</span> cv<span class="token punctuation">.</span>warpPerspective<span class="token punctuation">(</span>img<span class="token punctuation">,</span> M<span class="token punctuation">,</span> <span class="token punctuation">(</span>maxWidth<span class="token punctuation">,</span> maxHeight<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> warped</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">img <span class="token operator">=</span> cv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">&#39;./test.jpg&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 变形</span></span>
<span class="line">origin <span class="token operator">=</span> img<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">h<span class="token punctuation">,</span> w <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line">height <span class="token operator">=</span> <span class="token number">500</span></span>
<span class="line">ratio <span class="token operator">=</span> h <span class="token operator">/</span> height</span>
<span class="line">img_re <span class="token operator">=</span> cv<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>origin<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>w <span class="token operator">/</span> ratio<span class="token punctuation">)</span><span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">,</span> interpolation<span class="token operator">=</span>cv<span class="token punctuation">.</span>INTER_AREA<span class="token punctuation">)</span>  <span class="token comment"># 等比例放缩</span></span>
<span class="line">cv_show<span class="token punctuation">(</span>img_re<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 计算梯度方便检测边缘</span></span>
<span class="line">img_gray <span class="token operator">=</span> cv<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img_re<span class="token punctuation">,</span> cv<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span></span>
<span class="line">b<span class="token punctuation">,</span> g<span class="token punctuation">,</span> r <span class="token operator">=</span> cv<span class="token punctuation">.</span>split<span class="token punctuation">(</span>img_re<span class="token punctuation">)</span></span>
<span class="line">img_gray <span class="token operator">=</span> b  <span class="token comment"># 经过测试，灰度图纸张边缘梯度不明显，换成蓝色通道效果最好</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 经过测试，在梯度不明显情况下，Scharr比Sobel捕捉边缘效果更好</span></span>
<span class="line">scharrX <span class="token operator">=</span> cv<span class="token punctuation">.</span>Scharr<span class="token punctuation">(</span>img_gray<span class="token punctuation">,</span> cv<span class="token punctuation">.</span>CV_64F<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">scharrX <span class="token operator">=</span> cv<span class="token punctuation">.</span>convertScaleAbs<span class="token punctuation">(</span>scharrX<span class="token punctuation">)</span></span>
<span class="line">scharrY <span class="token operator">=</span> cv<span class="token punctuation">.</span>Scharr<span class="token punctuation">(</span>img_gray<span class="token punctuation">,</span> cv<span class="token punctuation">.</span>CV_64F<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">scharrY <span class="token operator">=</span> cv<span class="token punctuation">.</span>convertScaleAbs<span class="token punctuation">(</span>scharrY<span class="token punctuation">)</span></span>
<span class="line">img_gray <span class="token operator">=</span> cv<span class="token punctuation">.</span>addWeighted<span class="token punctuation">(</span>scharrX<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> scharrY<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">cv_show<span class="token punctuation">(</span>img_gray<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 滤波，将一些细碎的梯度滤掉，中值滤波比box效果好</span></span>
<span class="line">img_gray <span class="token operator">=</span> cv<span class="token punctuation">.</span>medianBlur<span class="token punctuation">(</span>img_gray<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span></span>
<span class="line">cv_show<span class="token punctuation">(</span>img_gray<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检测边缘</span></span>
<span class="line">img_edged <span class="token operator">=</span> cv<span class="token punctuation">.</span>Canny<span class="token punctuation">(</span>img_gray<span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">)</span></span>
<span class="line">cv_show<span class="token punctuation">(</span>img_edged<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 检测轮廓</span></span>
<span class="line">imgCnts<span class="token punctuation">,</span> hierarchy <span class="token operator">=</span> cv<span class="token punctuation">.</span>findContours<span class="token punctuation">(</span>img_edged<span class="token punctuation">,</span> cv<span class="token punctuation">.</span>RETR_EXTERNAL<span class="token punctuation">,</span> cv<span class="token punctuation">.</span>CHAIN_APPROX_NONE<span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 将轮廓按面积排序，方便定位要OCR的页面</span></span>
<span class="line">imgCnts <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>imgCnts<span class="token punctuation">,</span> key<span class="token operator">=</span>cv<span class="token punctuation">.</span>contourArea<span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span></span>
<span class="line">img_re_cp <span class="token operator">=</span> img_re<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">cv<span class="token punctuation">.</span>drawContours<span class="token punctuation">(</span>img_re_cp<span class="token punctuation">,</span> imgCnts<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line">cv_show<span class="token punctuation">(</span>img_re_cp<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 将轮廓近似，能近似成四点的即为要定位的页面</span></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>imgCnts<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># area = cv.contourArea(c)</span></span>
<span class="line">    <span class="token comment"># print(i,area)</span></span>
<span class="line">    peri <span class="token operator">=</span> cv<span class="token punctuation">.</span>arcLength<span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># print(i,peri)</span></span>
<span class="line">    approx <span class="token operator">=</span> cv<span class="token punctuation">.</span>approxPolyDP<span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token number">0.02</span> <span class="token operator">*</span> peri<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>approx<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span></span>
<span class="line">        screenCnt <span class="token operator">=</span> approx</span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line">    <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">        screenCnt <span class="token operator">=</span> imgCnts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token comment"># print(&quot;screenCnt:&quot;,screenCnt,&quot;\r\n&quot;,&quot;shape:&quot;,screenCnt.shape)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 绘制找到的轮廓</span></span>
<span class="line"><span class="token comment"># 之前找轮廓只保留了边角点，用[]括起来可以使轮廓按顺序连接</span></span>
<span class="line">cv<span class="token punctuation">.</span>drawContours<span class="token punctuation">(</span>img_re<span class="token punctuation">,</span> <span class="token punctuation">[</span>screenCnt<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line">cv_show<span class="token punctuation">(</span>img_re<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 透视变换</span></span>
<span class="line">screenCnt <span class="token operator">=</span> orderPoints<span class="token punctuation">(</span>screenCnt<span class="token punctuation">)</span></span>
<span class="line">warped <span class="token operator">=</span> perspectiveTransform<span class="token punctuation">(</span>origin<span class="token punctuation">,</span> screenCnt <span class="token operator">*</span> ratio<span class="token punctuation">)</span></span>
<span class="line">plt_show<span class="token punctuation">(</span>warped<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># # 二值处理</span></span>
<span class="line">warped <span class="token operator">=</span> cv<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>warped<span class="token punctuation">,</span> cv<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span></span>
<span class="line">warped <span class="token operator">=</span> cv<span class="token punctuation">.</span>threshold<span class="token punctuation">(</span>warped<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> cv<span class="token punctuation">.</span>THRESH_BINARY<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># OCR识别</span></span>
<span class="line">text <span class="token operator">=</span> pytesseract<span class="token punctuation">.</span>image_to_string<span class="token punctuation">(</span>warped<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>放缩后图像</p><p><img src="http://imagebed.krins.cloud/api/image/N8FHDZ28.png" alt="放缩后图像"></p><p>Scharr算子计算梯度</p><p><img src="http://imagebed.krins.cloud/api/image/8600XZ00.png" alt="计算梯度"></p><p>检测边缘</p><p><img src="http://imagebed.krins.cloud/api/image/L8TXT48Z.png" alt="检测边缘"></p><p>绘制较大轮廓</p><p><img src="http://imagebed.krins.cloud/api/image/JX4BZ62Z.png" alt="绘制面积前10大的轮廓"></p><p>检测要识别的区域</p><p><img src="http://imagebed.krins.cloud/api/image/0XXDJPPV.png" alt="要识别的区域"></p><p>透视变换效果</p><p><img src="http://imagebed.krins.cloud/api/image/JJJ60F02.png" alt="透视变换"></p><p>文字识别效果部分展示</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre><code><span class="line">1-7281-6212-6/20/$3 1.06 ©2020 [EFF | DOF 10.1199/1ROS45743 2020.9341117</span>
<span class="line">2020 IEEE/RSJ International Conference on Intelligent Robots and Systems (IROS) | 978</span>
<span class="line">2020 IEEE/RSJ International Conference on Intelligent Robots and Systems (IROS)</span>
<span class="line">October 25-29, 2020, Las Vegas, NV, USA (Virtual)</span>
<span class="line">An Approach to Reduce Communication for Multi-agent Mapping</span>
<span class="line">Applications</span>
<span class="line">Michael E. Kepler! and Daniel J. Stilwell?</span>
<span class="line">Abstract— In the context of a multi-agent system that uses a</span>
<span class="line">Gaussian process to estimate a spatial field of interest, we pro-</span>
<span class="line">pose an approach that enables an agent to reduce the amount of</span>
<span class="line">data it shares with other agents. The main idea of the strategy</span>
<span class="line">is to rigorously assign a novelty metric to each measurement</span>
<span class="line">as it is collected, and only measurements that are sufficiently</span>
<span class="line">novel are communicated. We consider the ideal scenario where</span>
<span class="line">an agent can instantly share novel measurements, and we also</span>
<span class="line">consider the more practical scenario in which communication</span>
<span class="line">suffers from low bandwidth and is range-limited. For this</span>
<span class="line">scenario, an agent can only broadcast an informative subset</span>
<span class="line">of the novel measurements when the agent encounters other</span>
<span class="line">agents. We explore three different informative criteria for</span>
<span class="line">subset selection, namely entropy, mutual information, and a new</span>
<span class="line">criterion that reflects the value of a measurement. We apply</span>
<span class="line">our approach to three real-world datasets relevant to robotic</span>
<span class="line">mapping. The empirical findings show that an agent can reduce</span>
<span class="line">the amount of communicated measurements by two orders of</span>
<span class="line">magnitude and that the new criterion for subset selection yields</span>
<span class="line">superior predictive performance relative to entropy and mutual</span>
<span class="line">information.</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="项目3-全景拼接" tabindex="-1"><a class="header-anchor" href="#项目3-全景拼接"><span>项目3：全景拼接</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">class</span> <span class="token class-name">Stitcher</span><span class="token punctuation">:</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">#拼接函数</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">stitch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> images<span class="token punctuation">,</span> ratio<span class="token operator">=</span><span class="token number">0.75</span><span class="token punctuation">,</span> reprojThresh<span class="token operator">=</span><span class="token number">4.0</span><span class="token punctuation">,</span>showMatches<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment">#获取输入图片</span></span>
<span class="line">        <span class="token punctuation">(</span>imageB<span class="token punctuation">,</span> imageA<span class="token punctuation">)</span> <span class="token operator">=</span> images</span>
<span class="line">        <span class="token comment">#检测 A、B 图片的 SIFT 关键特征点，并计算特征描述子</span></span>
<span class="line">        <span class="token punctuation">(</span>kpsA<span class="token punctuation">,</span> featuresA<span class="token punctuation">)</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>detectAndDescribe<span class="token punctuation">(</span>imageA<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">(</span>kpsB<span class="token punctuation">,</span> featuresB<span class="token punctuation">)</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>detectAndDescribe<span class="token punctuation">(</span>imageB<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 匹配两张图片的所有特征点，返回匹配结果</span></span>
<span class="line">        M <span class="token operator">=</span> self<span class="token punctuation">.</span>matchKeypoints<span class="token punctuation">(</span>kpsA<span class="token punctuation">,</span> kpsB<span class="token punctuation">,</span> featuresA<span class="token punctuation">,</span> featuresB<span class="token punctuation">,</span> ratio<span class="token punctuation">,</span> reprojThresh<span class="token punctuation">)</span>           </span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 如果返回结果为空，没有匹配成功的特征点，退出算法</span></span>
<span class="line">        <span class="token keyword">if</span> M <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 否则，提取匹配结果</span></span>
<span class="line">        <span class="token comment"># H是3x3视角变换矩阵      </span></span>
<span class="line">        <span class="token punctuation">(</span>matches<span class="token punctuation">,</span> H<span class="token punctuation">,</span> status<span class="token punctuation">)</span> <span class="token operator">=</span> M</span>
<span class="line">        <span class="token comment"># 将图片A进行视角变换，result是变换后图片</span></span>
<span class="line">        result <span class="token operator">=</span> cv<span class="token punctuation">.</span>warpPerspective<span class="token punctuation">(</span>imageA<span class="token punctuation">,</span> H<span class="token punctuation">,</span> <span class="token punctuation">(</span>imageA<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> imageB<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> imageA<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>cv_show<span class="token punctuation">(</span><span class="token string">&#39;result&#39;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment"># 将图片B传入result图片最左端</span></span>
<span class="line">        result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>imageB<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span>imageB<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> imageB</span>
<span class="line">        self<span class="token punctuation">.</span>cv_show<span class="token punctuation">(</span><span class="token string">&#39;result&#39;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment"># 检测是否需要显示图片匹配</span></span>
<span class="line">        <span class="token keyword">if</span> showMatches<span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 生成匹配图片</span></span>
<span class="line">            vis <span class="token operator">=</span> self<span class="token punctuation">.</span>drawMatches<span class="token punctuation">(</span>imageA<span class="token punctuation">,</span> imageB<span class="token punctuation">,</span> kpsA<span class="token punctuation">,</span> kpsB<span class="token punctuation">,</span> matches<span class="token punctuation">,</span> status<span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment"># 返回结果</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">(</span>result<span class="token punctuation">,</span> vis<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 返回匹配结果</span></span>
<span class="line">        <span class="token keyword">return</span> result</span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">cv_show</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>name<span class="token punctuation">,</span>img<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        cv<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>name<span class="token punctuation">,</span> img<span class="token punctuation">)</span></span>
<span class="line">        cv<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        cv<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">detectAndDescribe</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 将彩色图片转换成灰度图</span></span>
<span class="line">        gray <span class="token operator">=</span> cv<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>image<span class="token punctuation">,</span> cv<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 建立 SIFT 生成器</span></span>
<span class="line">        descriptor <span class="token operator">=</span> cv<span class="token punctuation">.</span>xfeatures2d<span class="token punctuation">.</span>SIFT_create<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment"># 检测 SIFT 特征点，并计算描述子</span></span>
<span class="line">        <span class="token punctuation">(</span>kps<span class="token punctuation">,</span> features<span class="token punctuation">)</span> <span class="token operator">=</span> descriptor<span class="token punctuation">.</span>detectAndCompute<span class="token punctuation">(</span>image<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 将结果转换成 NumPy 数组</span></span>
<span class="line">        kps <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span>kp<span class="token punctuation">.</span>pt <span class="token keyword">for</span> kp <span class="token keyword">in</span> kps<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 返回特征点集，及对应的描述特征</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span>kps<span class="token punctuation">,</span> features<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">matchKeypoints</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> kpsA<span class="token punctuation">,</span> kpsB<span class="token punctuation">,</span> featuresA<span class="token punctuation">,</span> featuresB<span class="token punctuation">,</span> ratio<span class="token punctuation">,</span> reprojThresh<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 建立暴力匹配器</span></span>
<span class="line">        matcher <span class="token operator">=</span> cv<span class="token punctuation">.</span>BFMatcher<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  </span>
<span class="line">        <span class="token comment"># 使用 KNN 检测来自 A、B 图的SIFT特征匹配对，K=2</span></span>
<span class="line">        rawMatches <span class="token operator">=</span> matcher<span class="token punctuation">.</span>knnMatch<span class="token punctuation">(</span>featuresA<span class="token punctuation">,</span> featuresB<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        matches <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">for</span> m <span class="token keyword">in</span> rawMatches<span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 当最近距离跟次近距离的比值小于 ratio 值时，保留此匹配对</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token keyword">and</span> m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>distance <span class="token operator">&lt;</span> m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>distance <span class="token operator">*</span> ratio<span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 存储两个点在 featuresA, featuresB 中的索引值</span></span>
<span class="line">                matches<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>trainIdx<span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>queryIdx<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 当筛选后的匹配对大于 4 时，计算视角变换矩阵</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>matches<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">4</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 获取匹配对的点坐标</span></span>
<span class="line">            ptsA <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span>kpsA<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">in</span> matches<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">            ptsB <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span>kpsB<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token keyword">in</span> matches<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment"># 计算视角变换矩阵</span></span>
<span class="line">            <span class="token punctuation">(</span>H<span class="token punctuation">,</span> status<span class="token punctuation">)</span> <span class="token operator">=</span> cv<span class="token punctuation">.</span>findHomography<span class="token punctuation">(</span>ptsA<span class="token punctuation">,</span> ptsB<span class="token punctuation">,</span> cv<span class="token punctuation">.</span>RANSAC<span class="token punctuation">,</span> reprojThresh<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment"># 返回结果</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">(</span>matches<span class="token punctuation">,</span> H<span class="token punctuation">,</span> status<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 如果匹配对小于4时，返回None</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">drawMatches</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> imageA<span class="token punctuation">,</span> imageB<span class="token punctuation">,</span> kpsA<span class="token punctuation">,</span> kpsB<span class="token punctuation">,</span> matches<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 初始化可视化图片，将A、B图左右连接到一起</span></span>
<span class="line">        <span class="token punctuation">(</span>hA<span class="token punctuation">,</span> wA<span class="token punctuation">)</span> <span class="token operator">=</span> imageA<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token punctuation">(</span>hB<span class="token punctuation">,</span> wB<span class="token punctuation">)</span> <span class="token operator">=</span> imageB<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span></span>
<span class="line">        vis <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>hA<span class="token punctuation">,</span> hB<span class="token punctuation">)</span><span class="token punctuation">,</span> wA <span class="token operator">+</span> wB<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">&quot;uint8&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        vis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>hA<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span>wA<span class="token punctuation">]</span> <span class="token operator">=</span> imageA</span>
<span class="line">        vis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>hB<span class="token punctuation">,</span> wA<span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> imageB</span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 联合遍历，画出匹配对</span></span>
<span class="line">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>trainIdx<span class="token punctuation">,</span> queryIdx<span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>matches<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 当点对匹配成功时，画到可视化图上</span></span>
<span class="line">            <span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token comment"># 画出匹配对</span></span>
<span class="line">                ptA <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>kpsA<span class="token punctuation">[</span>queryIdx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>kpsA<span class="token punctuation">[</span>queryIdx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                ptB <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>kpsB<span class="token punctuation">[</span>trainIdx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> wA<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>kpsB<span class="token punctuation">[</span>trainIdx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                cv<span class="token punctuation">.</span>line<span class="token punctuation">(</span>vis<span class="token punctuation">,</span> ptA<span class="token punctuation">,</span> ptB<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 返回可视化结果</span></span>
<span class="line">        <span class="token keyword">return</span> vis</span>
<span class="line">    </span>
<span class="line"><span class="token comment"># 读取拼接图片</span></span>
<span class="line">imageA <span class="token operator">=</span> cv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">&quot;./pic/21_Left_01.png&quot;</span><span class="token punctuation">)</span></span>
<span class="line">imageB <span class="token operator">=</span> cv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">&quot;./pic/22_Right_01.png&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 把图片拼接成全景图</span></span>
<span class="line">stitcher <span class="token operator">=</span> Stitcher<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 实例化 Stitcher 对象</span></span>
<span class="line"><span class="token punctuation">(</span>result<span class="token punctuation">,</span> vis<span class="token punctuation">)</span> <span class="token operator">=</span> stitcher<span class="token punctuation">.</span>stitch<span class="token punctuation">(</span><span class="token punctuation">[</span>imageA<span class="token punctuation">,</span> imageB<span class="token punctuation">]</span><span class="token punctuation">,</span> showMatches<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 显示所有图片</span></span>
<span class="line">cv<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">&quot;Image A&quot;</span><span class="token punctuation">,</span> imageA<span class="token punctuation">)</span></span>
<span class="line">cv<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">&quot;Image B&quot;</span><span class="token punctuation">,</span> imageB<span class="token punctuation">)</span></span>
<span class="line">cv<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">&quot;Keypoint Matches&quot;</span><span class="token punctuation">,</span> vis<span class="token punctuation">)</span></span>
<span class="line">cv<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">&quot;Result&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span></span>
<span class="line">cv<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">cv<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://imagebed.krins.cloud/api/image/L40BL8P6.png" alt="imageA"></p><p><img src="http://imagebed.krins.cloud/api/image/T8J6XDN2.png" alt="imageB"></p><p><img src="http://imagebed.krins.cloud/api/image/60846FLJ.png" alt="result"></p><p><img src="http://imagebed.krins.cloud/api/image/0628BPXH.png" alt="KeypointMatches"></p><h4 id="项目4-运动对象检测" tabindex="-1"><a class="header-anchor" href="#项目4-运动对象检测"><span>项目4：运动对象检测</span></a></h4><ol><li>混合高斯模型</li></ol><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np</span>
<span class="line"><span class="token keyword">import</span> cv2</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 测试视频</span></span>
<span class="line">cap <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 形态学操作需要使用</span></span>
<span class="line">kernel <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getStructuringElement<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>MORPH_ELLIPSE<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 创建混合高斯模型用于背景建模</span></span>
<span class="line">fgbg <span class="token operator">=</span> cv2<span class="token punctuation">.</span>createBackgroundSubtractorMOG2<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 混合高斯模型实例化对象</span></span>
<span class="line"><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    </span>
<span class="line">    ret<span class="token punctuation">,</span>frame <span class="token operator">=</span> cap<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>    </span>
<span class="line">    fgmask <span class="token operator">=</span> fgbg<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span>    <span class="token comment"># 每一帧应用到混合高斯模型中</span></span>
<span class="line">    <span class="token comment"># 形态学开运算去噪点</span></span>
<span class="line">    fgmask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>morphologyEx<span class="token punctuation">(</span>fgmask<span class="token punctuation">,</span>cv2<span class="token punctuation">.</span>MORPH_OPEN<span class="token punctuation">,</span>kernel<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># 寻找视频中的轮廓</span></span>
<span class="line">    contours<span class="token punctuation">,</span> hierarchy <span class="token operator">=</span> cv2<span class="token punctuation">.</span>findContours<span class="token punctuation">(</span>fgmask<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>RETR_EXTERNAL<span class="token punctuation">,</span>cv2<span class="token punctuation">.</span>CHAIN_APPROX_SIMPLE<span class="token punctuation">)</span>    </span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> c <span class="token keyword">in</span> contours<span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 计算各轮廓的周长</span></span>
<span class="line">        perimeter <span class="token operator">=</span> cv2<span class="token punctuation">.</span>arcLength<span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">if</span> perimeter <span class="token operator">&gt;</span> <span class="token number">188</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 找到一个直矩形 </span></span>
<span class="line">            x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> cv2<span class="token punctuation">.</span>boundingRect<span class="token punctuation">(</span>c<span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment"># 画出这个矩形</span></span>
<span class="line">            cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>frame<span class="token punctuation">,</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>x<span class="token operator">+</span>w<span class="token punctuation">,</span>y<span class="token operator">+</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line">            </span>
<span class="line">    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">&#39;frame&#39;</span><span class="token punctuation">,</span>frame<span class="token punctuation">)</span></span>
<span class="line">    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">&#39;fgmask&#39;</span><span class="token punctuation">,</span>fgmask<span class="token punctuation">)</span></span>
<span class="line">    cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token number">0xff</span> <span class="token operator">==</span> <span class="token number">27</span><span class="token punctuation">:</span><span class="token comment"># 表示按退出键 ESC</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line"></span>
<span class="line">cap<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><p>光流估计</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py" data-title="py"><pre><code><span class="line"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np</span>
<span class="line"><span class="token keyword">import</span> cv2</span>
<span class="line"></span>
<span class="line">cap <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 角点检测所需参数</span></span>
<span class="line"><span class="token comment"># 如果不限制角点最大数量，速度就会有些慢，达不到实时的效果</span></span>
<span class="line"><span class="token comment"># 品质因子会筛选角点，品质因子设置的越大，得到的角点越少                </span></span>
<span class="line">feature_params <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span> maxCorners <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">                       qualityLevel <span class="token operator">=</span> <span class="token number">0.3</span><span class="token punctuation">,</span></span>
<span class="line">                       minDistance <span class="token operator">=</span> <span class="token number">7</span> <span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># lucas-kanada参数</span></span>
<span class="line"><span class="token comment"># winSize：窗口大小 maxLevel：金字塔层数</span></span>
<span class="line">lk_params <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span> winSize <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> </span>
<span class="line">                  maxLevel <span class="token operator">=</span> <span class="token number">2</span> <span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 随机颜色条</span></span>
<span class="line">color <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 拿到第一帧图像</span></span>
<span class="line">ret<span class="token punctuation">,</span> old_frame <span class="token operator">=</span> cap<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">old_gray <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>old_frame<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># cv2.goodFeaturesToTrack函数返回所有检测特征点，需要输入：图像，角点最大数量(效率)，品质因子(特征值越大的越好来筛选)                                  </span></span>
<span class="line"><span class="token comment"># 距离相当于这区间有比这个角点强的，就不要这个弱的了</span></span>
<span class="line"><span class="token comment"># **变量 作为传入参数，是用来传入不定长的变量</span></span>
<span class="line">p0 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>goodFeaturesToTrack<span class="token punctuation">(</span>old_gray<span class="token punctuation">,</span> mask <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>feature_params<span class="token punctuation">)</span>  <span class="token comment"># 拿到第一帧的角点，后面视频中是对第一帧的角点进行追踪     </span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 创建一个 mask</span></span>
<span class="line">mask <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>old_frame<span class="token punctuation">)</span> <span class="token comment"># 创建同维度的全0矩阵</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> cap<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    frame_gray <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>frame<span class="token punctuation">,</span>cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>                       </span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># 需要传入前一帧和当前图像以及前一帧检测到的角点</span></span>
<span class="line">    p1<span class="token punctuation">,</span> st<span class="token punctuation">,</span> err <span class="token operator">=</span> cv2<span class="token punctuation">.</span>calcOpticalFlowPyrLK<span class="token punctuation">(</span>old_gray<span class="token punctuation">,</span> frame_gray<span class="token punctuation">,</span> p0<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>lk_params<span class="token punctuation">)</span>                         </span>
<span class="line">    </span>
<span class="line">    <span class="token comment"># st=1 表示</span></span>
<span class="line">    good_new <span class="token operator">=</span> p1<span class="token punctuation">[</span>st<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># st==1 表示找到的特征点，没找到的特征点就不要了</span></span>
<span class="line">    good_old <span class="token operator">=</span> p0<span class="token punctuation">[</span>st<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>new<span class="token punctuation">,</span>old<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>good_new<span class="token punctuation">,</span>good_old<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        a<span class="token punctuation">,</span>b <span class="token operator">=</span> new<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        c<span class="token punctuation">,</span>d <span class="token operator">=</span> old<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>line<span class="token punctuation">(</span>mask<span class="token punctuation">,</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span>color<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>               <span class="token comment"># np.tolist将矩阵转为列表          </span></span>
<span class="line">        frame <span class="token operator">=</span> cv2<span class="token punctuation">.</span>circle<span class="token punctuation">(</span>frame<span class="token punctuation">,</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span>color<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment"># -1表示画实心圆 </span></span>
<span class="line">    img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>add<span class="token punctuation">(</span>frame<span class="token punctuation">,</span>mask<span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">&#39;frame&#39;</span><span class="token punctuation">,</span>img<span class="token punctuation">)</span></span>
<span class="line">    cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token number">0xff</span> <span class="token operator">==</span> <span class="token number">27</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line">        </span>
<span class="line">    <span class="token comment"># 更新</span></span>
<span class="line">    old_gray <span class="token operator">=</span> frame_gray<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    p0 <span class="token operator">=</span> good_new<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">cap<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料"><span>参考资料</span></a></h3><ol><li><p><a href="https://www.bilibili.com/video/BV1PV411774y?p=9&amp;spm_id_from=pageDriver&amp;vd_source=f7fc0a964268b45e70067d58c7c397fc" target="_blank" rel="noopener noreferrer">【2022B站最好的OpenCV课程推荐】OpenCV从入门到实战 全套课程（附带课程课件资料+课件笔记）图像处理|深度学习人工智能计算机视觉python+AI<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p><a href="https://github.com/AccumulateMore/OpenCV" target="_blank" rel="noopener noreferrer">最全面的 OpenCV 笔记<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li></ol></div></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Last Updated 4/12/2025, 1:07:53 AM<!--]--></span></span></div></footer><!----><!----></div><div class="page-catalog-container"><h5 class="tip">ON THIS PAGE</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/Python/opencv-python.html#opencv-python库的使用" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="openCV-python库的使用"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->openCV-python库的使用<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/Python/opencv-python.html#参考资料" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="参考资料"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->参考资料<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--]--></ul></div></main><!--]--></div></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BSRiWrsC.js" defer></script>
  </body>
</html>
